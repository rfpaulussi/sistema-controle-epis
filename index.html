<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de EPIs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js para gráficos interativos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        danger: '#ef4444',
                        success: '#10b981',
                        warning: '#f59e0b',
                        info: '#3b82f6'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Tela de Login -->
    <div id="tela-login" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-primary">Sistema de Controle de EPIs</h1>
                <p class="text-gray-600">Faça login para acessar o sistema</p>
            </div>
            
            <form id="form-login" class="space-y-4">
                <div>
                    <label for="usuario" class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
                    <input 
                        type="text" 
                        id="usuario" 
                        required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                </div>
                
                <div>
                    <label for="senha" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input 
                        type="password" 
                        id="senha" 
                        required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                </div>
                
                <div id="erro-login" class="hidden text-danger text-sm bg-red-50 p-2 rounded"></div>
                
                <button 
                    type="submit" 
                    class="w-full bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90"
                >
                    <i class="fas fa-sign-in-alt mr-2"></i> Entrar
                </button>
                
                <!-- Removidas credenciais de exemplo para aumentar a segurança -->
            </form>
        </div>
    </div>

    <!-- Tela Principal (fica oculta até o login) -->
    <div id="tela-principal" class="hidden">
        <div class="container mx-auto px-4 py-8">
            <!-- Cabeçalho com informações do usuário -->
            <header class="mb-8 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
                <div>
                    <h1 class="text-3xl font-bold text-primary">Sistema de Controle de EPIs</h1>
                    <p class="text-gray-600 mt-2">Gerencie os Equipamentos de Proteção Individual da empresa</p>
                </div>
                <div class="flex items-center bg-white py-2 px-4 rounded-lg shadow-sm">
                    <span class="mr-4 flex items-center text-gray-700">
                        <i class="fas fa-user-circle text-primary text-xl mr-2"></i>
                        <span>
                            <span class="text-sm text-gray-500">Usuário:</span><br>
                            <span id="usuario-logado" class="font-medium">Nome do Usuário</span>
                        </span>
                    </span>
                    <button 
                        onclick="realizarLogout()" 
                        class="bg-gray-200 text-gray-700 px-3 py-1 rounded hover:bg-gray-300 flex items-center"
                    >
                        <i class="fas fa-sign-out-alt mr-1"></i> Sair
                    </button>
                </div>
            </header>
            
            <!-- Painel de gerenciamento de dados -->
            <div class="bg-yellow-50 border-yellow-200 border rounded-lg p-4 mb-6">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div>
                        <h3 class="font-medium text-yellow-700">Aviso: Seus dados são temporários</h3>
                        <p class="text-sm text-yellow-600">Os dados são armazenados apenas durante a sessão atual. 
                        Faça exportações regulares para evitar perda de informações.</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="exportarDados()" 
                            class="bg-primary text-white px-3 py-2 rounded hover:bg-primary/90 flex items-center">
                            <i class="fas fa-download mr-2"></i> Exportar Dados
                        </button>
                        
                        <label for="input-importar" class="bg-info text-white px-3 py-2 rounded hover:bg-info/90 flex items-center cursor-pointer">
                            <i class="fas fa-upload mr-2"></i> Importar Dados
                        </label>
                        <input type="file" id="input-importar" accept=".json" 
                            onchange="importarDados(event)" class="hidden">
                    </div>
                </div>
            </div>

            <!-- Menu de Navegação -->
            <div class="bg-white shadow rounded-lg mb-6 overflow-x-auto">
                <div class="flex flex-wrap">
                    <button id="tab-epis" onclick="mudarTab('epis')" class="px-4 py-3 font-medium border-b-2 border-primary text-primary">
                        <i class="fas fa-hard-hat mr-2"></i>EPIs
                    </button>
                    <button id="tab-entradas" onclick="mudarTab('entradas')" class="px-4 py-3 font-medium text-gray-500 hover:text-primary">
                        <i class="fas fa-arrow-right-to-bracket mr-2"></i>Entradas
                    </button>
                    <button id="tab-saidas" onclick="mudarTab('saidas')" class="px-4 py-3 font-medium text-gray-500 hover:text-primary">
                        <i class="fas fa-arrow-right-from-bracket mr-2"></i>Saídas
                    </button>
                    <button id="tab-centros" onclick="mudarTab('centros')" class="px-4 py-3 font-medium text-gray-500 hover:text-primary">
                        <i class="fas fa-sitemap mr-2"></i>Centros de Custo
                    </button>
                    <button id="tab-provisoes" onclick="mudarTab('provisoes')" class="px-4 py-3 font-medium text-gray-500 hover:text-primary">
                        <i class="fas fa-calendar-alt mr-2"></i>Provisionamentos
                    </button>
                    <button id="tab-relatorios" onclick="mudarTab('relatorios')" class="px-4 py-3 font-medium text-gray-500 hover:text-primary">
                        <i class="fas fa-chart-bar mr-2"></i>Relatórios
                    </button>
                    <button id="tab-usuarios" onclick="mudarTab('usuarios')" class="px-4 py-3 font-medium text-gray-500 hover:text-primary">
                        <i class="fas fa-users-cog mr-2"></i>Usuários
                    </button>
                </div>
            </div>

        <!-- Conteúdo da aba EPIs -->
        <div id="conteudo-epis">
            <!-- Barra de ações -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex flex-col md:flex-row items-center gap-2 w-full md:w-auto">
                    <input 
                        type="text" 
                        id="busca-epi" 
                        placeholder="Buscar por nome ou código..." 
                        class="border border-gray-300 rounded-lg px-4 py-2 w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                    <button 
                        onclick="buscarEPIs()" 
                        class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 w-full md:w-auto"
                    >
                        <i class="fas fa-search mr-2"></i>Buscar
                    </button>
                </div>
                <button 
                    onclick="abrirModalCadastro()" 
                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 flex items-center w-full md:w-auto justify-center"
                >
                    <i class="fas fa-plus-circle mr-2"></i>Novo EPI
                </button>
            </div>

            <!-- Tabela de EPIs -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Código</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estoque</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estoque Mínimo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Custo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="tabela-epis">
                        <!-- Dados serão inseridos via JavaScript -->
                    </tbody>
                </table>
                <div id="sem-registros-epis" class="hidden p-8 text-center text-gray-500">
                    Nenhum EPI cadastrado. Clique em "Novo EPI" para adicionar.
                </div>
            </div>
        </div>

        <!-- Conteúdo da aba Entradas -->
        <div id="conteudo-entradas" class="hidden">
            <!-- Barra de ações -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex flex-col md:flex-row items-center gap-2 w-full md:w-auto">
                    <select 
                        id="filtro-entrada-epi" 
                        class="border border-gray-300 rounded-lg px-4 py-2 w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                        <option value="">Todos os EPIs</option>
                    </select>
                    <button 
                        onclick="filtrarEntradas()" 
                        class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 w-full md:w-auto"
                    >
                        <i class="fas fa-filter mr-2"></i>Filtrar
                    </button>
                </div>
                <button 
                    onclick="abrirModalEntrada()" 
                    class="bg-success text-white px-4 py-2 rounded-lg hover:bg-success/90 flex items-center w-full md:w-auto justify-center"
                >
                    <i class="fas fa-plus-circle mr-2"></i>Nova Entrada
                </button>
            </div>

            <!-- Tabela de Entradas com scroll horizontal melhorado -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto w-full">
                    <table class="min-w-full divide-y divide-gray-200 table-fixed">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-24">Data</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-56">EPI</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-24">Qtd</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32">Custo Unit.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32">Valor Total</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-36">Nota Fiscal</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-40">Responsável</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-20">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="tabela-entradas">
                            <!-- Dados serão inseridos via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="sem-registros-entradas" class="hidden p-8 text-center text-gray-500">
                    Nenhuma entrada registrada. Clique em "Nova Entrada" para adicionar.
                </div>
            </div>
        </div>

        <!-- Conteúdo da aba Saídas -->
        <div id="conteudo-saidas" class="hidden">
            <!-- Barra de ações -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex flex-col md:flex-row items-center gap-2 w-full md:w-auto">
                    <select 
                        id="filtro-saida-epi" 
                        class="border border-gray-300 rounded-lg px-4 py-2 w-full md:w-auto focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                        <option value="">Todos os EPIs</option>
                    </select>
                    <select 
                        id="filtro-saida-centro" 
                        class="border border-gray-300 rounded-lg px-4 py-2 w-full md:w-auto focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                        <option value="">Todos os Centros</option>
                    </select>
                    <button 
                        onclick="filtrarSaidas()" 
                        class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 w-full md:w-auto"
                    >
                        <i class="fas fa-filter mr-2"></i>Filtrar
                    </button>
                </div>
                <button 
                    onclick="abrirModalSaida()" 
                    class="bg-warning text-white px-4 py-2 rounded-lg hover:bg-warning/90 flex items-center w-full md:w-auto justify-center"
                >
                    <i class="fas fa-minus-circle mr-2"></i>Nova Saída
                </button>
            </div>

            <!-- Tabela de Saídas com scroll horizontal melhorado -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto w-full">
                    <table class="min-w-full divide-y divide-gray-200 table-fixed">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-24">Data</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-56">EPI</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-24">Qtd</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-48">Centro de Custo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-36">Destino</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32">Valor Total</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-40">Responsável</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-20">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="tabela-saidas">
                            <!-- Dados serão inseridos via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="sem-registros-saidas" class="hidden p-8 text-center text-gray-500">
                    Nenhuma saída registrada. Clique em "Nova Saída" para adicionar.
                </div>
            </div>
        </div>

        <!-- Conteúdo da aba Centros de Custo -->
        <div id="conteudo-centros" class="hidden">
            <!-- Barra de ações -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex flex-col md:flex-row items-center gap-2 w-full md:w-auto">
                    <input 
                        type="text" 
                        id="busca-centro" 
                        placeholder="Buscar por contrato ou código..." 
                        class="border border-gray-300 rounded-lg px-4 py-2 w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                    <button 
                        onclick="buscarCentros()" 
                        class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 w-full md:w-auto"
                    >
                        <i class="fas fa-search mr-2"></i>Buscar
                    </button>
                </div>
                <button 
                    onclick="abrirModalCentro()" 
                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 flex items-center w-full md:w-auto justify-center"
                >
                    <i class="fas fa-plus-circle mr-2"></i>Novo Centro de Custo
                </button>
            </div>

            <!-- Tabela de Centros de Custo -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Código</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contrato</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Responsável</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Setor</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="tabela-centros">
                        <!-- Dados serão inseridos via JavaScript -->
                    </tbody>
                </table>
                <div id="sem-registros-centros" class="hidden p-8 text-center text-gray-500">
                    Nenhum centro de custo cadastrado. Clique em "Novo Centro de Custo" para adicionar.
                </div>
            </div>
        </div>

        <!-- Conteúdo da aba Provisionamentos -->
        <div id="conteudo-provisoes" class="hidden">
            <!-- Barra de ações -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex flex-col md:flex-row items-center gap-2 w-full md:w-auto">
                    <select 
                        id="filtro-provisao-centro" 
                        class="border border-gray-300 rounded-lg px-4 py-2 w-full md:w-auto focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                        <option value="">Todos os Centros</option>
                    </select>
                    <select 
                        id="filtro-provisao-status" 
                        class="border border-gray-300 rounded-lg px-4 py-2 w-full md:w-auto focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                        <option value="">Todos os Status</option>
                        <option value="Solicitado">Solicitado</option>
                        <option value="Aprovado">Aprovado</option>
                        <option value="Rejeitado">Rejeitado</option>
                    </select>
                    <select 
                        id="filtro-provisao-mes" 
                        class="border border-gray-300 rounded-lg px-4 py-2 w-full md:w-auto focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                        <option value="">Todos os Meses</option>
                        <option value="01/2024">Janeiro/2024</option>
                        <option value="02/2024">Fevereiro/2024</option>
                        <option value="03/2024">Março/2024</option>
                        <option value="04/2024">Abril/2024</option>
                        <option value="05/2024">Maio/2024</option>
                        <option value="06/2024">Junho/2024</option>
                        <option value="07/2024">Julho/2024</option>
                        <option value="08/2024">Agosto/2024</option>
                        <option value="09/2024">Setembro/2024</option>
                        <option value="10/2024">Outubro/2024</option>
                        <option value="11/2024">Novembro/2024</option>
                        <option value="12/2024">Dezembro/2024</option>
                    </select>
                    <button 
                        onclick="filtrarProvisoes()" 
                        class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 w-full md:w-auto"
                    >
                        <i class="fas fa-filter mr-2"></i>Filtrar
                    </button>
                </div>
                <button 
                    onclick="abrirModalProvisao()" 
                    class="bg-info text-white px-4 py-2 rounded-lg hover:bg-info/90 flex items-center w-full md:w-auto justify-center"
                >
                    <i class="fas fa-calendar-plus mr-2"></i>Nova Provisão
                </button>
            </div>

            <!-- Tabela de Provisionamentos com scroll horizontal melhorado -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto w-full">
                    <table class="min-w-full divide-y divide-gray-200 table-fixed">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32">Data Solicitação</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-56">Centro de Custo</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32">Mês/Ano Ref.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-28">Qtd Itens</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-32">Valor Estimado</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-28">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-40">Responsável</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-20">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="tabela-provisoes">
                            <!-- Dados serão inseridos via JavaScript -->
                        </tbody>
                    </table>
                </div>
                <div id="sem-registros-provisoes" class="hidden p-8 text-center text-gray-500">
                    Nenhum provisionamento cadastrado. Clique em "Nova Provisão" para adicionar.
                </div>
            </div>
        </div>

        <!-- Conteúdo da aba Relatórios -->
        <div id="conteudo-relatorios" class="hidden">
            <div class="mb-6">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Relatório de Consumo de EPIs por Centro de Custo</h2>
                    
                    <!-- Filtros do relatório -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div>
                            <label for="relatorio-periodo-inicio" class="block text-sm font-medium text-gray-700 mb-1">
                                Período - Início
                            </label>
                            <input 
                                type="date" 
                                id="relatorio-periodo-inicio" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary"
                            >
                        </div>
                        <div>
                            <label for="relatorio-periodo-fim" class="block text-sm font-medium text-gray-700 mb-1">
                                Período - Fim
                            </label>
                            <input 
                                type="date" 
                                id="relatorio-periodo-fim" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary"
                            >
                        </div>
                        <div>
                            <label for="relatorio-centro" class="block text-sm font-medium text-gray-700 mb-1">
                                Centro de Custo
                            </label>
                            <select 
                                id="relatorio-centro" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary"
                            >
                                <option value="">Todos os Centros</option>
                                <!-- Opções serão carregadas via JavaScript -->
                            </select>
                        </div>
                        <div>
                            <label for="relatorio-categoria" class="block text-sm font-medium text-gray-700 mb-1">
                                Categoria de EPI
                            </label>
                            <select 
                                id="relatorio-categoria" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-base focus:outline-none focus:ring-2 focus:ring-primary"
                            >
                                <option value="">Todas as Categorias</option>
                                <option value="Capacetes">Capacetes</option>
                                <option value="Luvas">Luvas</option>
                                <option value="Óculos">Óculos</option>
                                <option value="Protetores Auditivos">Protetores Auditivos</option>
                                <option value="Respiradores">Respiradores</option>
                                <option value="Calçados">Calçados</option>
                                <option value="Cintos">Cintos</option>
                                <option value="Vestimentas">Vestimentas</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex justify-end mb-6">
                        <button 
                            onclick="gerarRelatorioConsumo()" 
                            class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90"
                        >
                            <i class="fas fa-chart-line mr-2"></i>Gerar Relatório
                        </button>
                    </div>
                    
                    <!-- Alertas -->
                    <div id="relatorio-alerta" class="hidden mb-6"></div>
                    
                    <!-- Relatório Gerado -->
                    <div id="relatorio-resultado" class="hidden">
                        <div class="flex flex-col md:flex-row justify-between mb-4">
                            <h3 class="text-lg font-bold text-gray-700" id="relatorio-titulo">Consumo de EPIs por Centro de Custo</h3>
                            <div>
                                <button onclick="exportarRelatorioPDF()" class="bg-danger text-white px-3 py-1 rounded hover:bg-danger/90 text-sm mr-2">
                                    <i class="fas fa-file-pdf mr-1"></i> PDF
                                </button>
                                <button onclick="exportarRelatorioExcel()" class="bg-success text-white px-3 py-1 rounded hover:bg-success/90 text-sm">
                                    <i class="fas fa-file-excel mr-1"></i> Excel
                                </button>
                            </div>
                        </div>
                        
                        <!-- Gráficos -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white border rounded-lg p-4">
                                <h4 class="text-base font-semibold text-gray-700 mb-3">Distribuição por Centro de Custo</h4>
                                <div class="h-64">
                                    <canvas id="grafico-consumo-centro"></canvas>
                                </div>
                            </div>
                            <div class="bg-white border rounded-lg p-4">
                                <h4 class="text-base font-semibold text-gray-700 mb-3">Distribuição por Categoria</h4>
                                <div class="h-64">
                                    <canvas id="grafico-consumo-categoria"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Resumo de indicadores -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-blue-50 border-blue-200 border rounded-lg p-4">
                                <p class="text-sm text-blue-600">Total de Itens Consumidos</p>
                                <p class="text-2xl font-bold text-blue-700" id="indicador-total-itens">0</p>
                            </div>
                            <div class="bg-green-50 border-green-200 border rounded-lg p-4">
                                <p class="text-sm text-green-600">Valor Total (R$)</p>
                                <p class="text-2xl font-bold text-green-700" id="indicador-valor-total">R$ 0,00</p>
                            </div>
                            <div class="bg-yellow-50 border-yellow-200 border rounded-lg p-4">
                                <p class="text-sm text-yellow-600">Centro com Maior Consumo</p>
                                <p class="text-xl font-bold text-yellow-700" id="indicador-maior-centro">-</p>
                            </div>
                            <div class="bg-purple-50 border-purple-200 border rounded-lg p-4">
                                <p class="text-sm text-purple-600">EPI Mais Consumido</p>
                                <p class="text-xl font-bold text-purple-700" id="indicador-maior-epi">-</p>
                            </div>
                        </div>
                        
                        <!-- Tabela detalhada -->
                        <h4 class="text-lg font-semibold text-gray-700 mb-3">Detalhamento do Consumo</h4>
                        <div class="overflow-x-auto bg-white border rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Centro de Custo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">EPI</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Categoria</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantidade</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor Unitário</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Valor Total</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">% do Total</th>
                                    </tr>
                                </thead>
                                <tbody id="tabela-relatorio-consumo" class="bg-white divide-y divide-gray-200">
                                    <!-- Dados serão inseridos via JavaScript -->
                                </tbody>
                                <tfoot class="bg-gray-50 font-semibold">
                                    <tr>
                                        <td colspan="3" class="px-6 py-3 text-right">Totais:</td>
                                        <td id="total-quantidade" class="px-6 py-3">0</td>
                                        <td class="px-6 py-3">-</td>
                                        <td id="total-valor" class="px-6 py-3">R$ 0,00</td>
                                        <td class="px-6 py-3">100%</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Conteúdo da aba Usuários -->
        <div id="conteudo-usuarios" class="hidden">
            <!-- Barra de ações -->
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex flex-col md:flex-row items-center gap-2 w-full md:w-auto">
                    <input 
                        type="text" 
                        id="busca-usuario" 
                        placeholder="Buscar por nome ou usuário..." 
                        class="border border-gray-300 rounded-lg px-4 py-2 w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                    <button 
                        onclick="buscarUsuarios()" 
                        class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 w-full md:w-auto"
                    >
                        <i class="fas fa-search mr-2"></i>Buscar
                    </button>
                </div>
                <button 
                    onclick="abrirModalUsuario()" 
                    class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 flex items-center w-full md:w-auto justify-center"
                >
                    <i class="fas fa-user-plus mr-2"></i>Novo Usuário
                </button>
            </div>

            <!-- Tabela de Usuários -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Usuário</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Perfil</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Último Acesso</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="tabela-usuarios">
                        <!-- Será preenchido via JavaScript -->
                    </tbody>
                </table>
                <div id="sem-registros-usuarios" class="hidden p-8 text-center text-gray-500">
                    Nenhum usuário cadastrado. Clique em "Novo Usuário" para adicionar.
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro/Edição de EPI -->
    <div id="modal-epi" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="modal-titulo" class="text-xl font-bold text-gray-800">Cadastrar Novo EPI</h2>
                <button onclick="fecharModalCadastro()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="form-epi" class="p-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="epi-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Nome -->
                    <div>
                        <label for="epi-nome" class="block text-sm font-medium text-gray-700 mb-1">
                            Nome <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="epi-nome" 
                            required 
                            placeholder="Ex: Capacete de Segurança" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Código -->
                    <div>
                        <label for="epi-codigo" class="block text-sm font-medium text-gray-700 mb-1">
                            Código de Barras / SKU
                        </label>
                        <input 
                            type="text" 
                            id="epi-codigo" 
                            placeholder="Ex: 7891234567890" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Categoria -->
                    <div>
                        <label for="epi-categoria" class="block text-sm font-medium text-gray-700 mb-1">
                            Categoria <span class="text-danger">*</span>
                        </label>
                        <select 
                            id="epi-categoria" 
                            required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base appearance-none"
                        >
                            <option value="">Selecione uma categoria</option>
                            <option value="Capacetes">Capacetes</option>
                            <option value="Luvas">Luvas</option>
                            <option value="Óculos">Óculos</option>
                            <option value="Protetores Auditivos">Protetores Auditivos</option>
                            <option value="Respiradores">Respiradores</option>
                            <option value="Calçados">Calçados</option>
                            <option value="Cintos">Cintos</option>
                            <option value="Vestimentas">Vestimentas</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    
                    <!-- Unidade de Medida -->
                    <div>
                        <label for="epi-unidade" class="block text-sm font-medium text-gray-700 mb-1">
                            Unidade de Medida <span class="text-danger">*</span>
                        </label>
                        <select 
                            id="epi-unidade" 
                            required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base appearance-none"
                        >
                            <option value="">Selecione uma unidade</option>
                            <option value="Unidade">Unidade</option>
                            <option value="Par">Par</option>
                            <option value="Caixa">Caixa</option>
                            <option value="Pacote">Pacote</option>
                            <option value="Kit">Kit</option>
                        </select>
                    </div>
                    
                    <!-- Estoque Inicial -->
                    <div>
                        <label for="epi-estoque" class="block text-sm font-medium text-gray-700 mb-1">
                            Estoque Atual <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="epi-estoque" 
                            required 
                            min="0" 
                            placeholder="Ex: 100" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Estoque Mínimo -->
                    <div>
                        <label for="epi-estoque-minimo" class="block text-sm font-medium text-gray-700 mb-1">
                            Estoque Mínimo <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="epi-estoque-minimo" 
                            required 
                            min="0" 
                            placeholder="Ex: 20" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Custo Unitário -->
                    <div>
                        <label for="epi-custo" class="block text-sm font-medium text-gray-700 mb-1">
                            Custo Unitário (R$) <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="epi-custo" 
                            required 
                            min="0" 
                            step="0.01" 
                            placeholder="Ex: 35.90" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Validade -->
                    <div>
                        <label for="epi-validade" class="block text-sm font-medium text-gray-700 mb-1">
                            Validade
                        </label>
                        <input 
                            type="date" 
                            id="epi-validade" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Número CA -->
                    <div>
                        <label for="epi-ca" class="block text-sm font-medium text-gray-700 mb-1">
                            Número do CA <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="epi-ca" 
                            required 
                            placeholder="Ex: 12345" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Fornecedor -->
                    <div>
                        <label for="epi-fornecedor" class="block text-sm font-medium text-gray-700 mb-1">
                            Fornecedor <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="epi-fornecedor" 
                            required 
                            placeholder="Ex: 3M Brasil" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Localização -->
                    <div>
                        <label for="epi-localizacao" class="block text-sm font-medium text-gray-700 mb-1">
                            Localização no Estoque
                        </label>
                        <input 
                            type="text" 
                            id="epi-localizacao" 
                            placeholder="Ex: Prateleira A1, Estante 2" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                </div>
                
                <!-- Descrição -->
                <div class="mb-4">
                    <label for="epi-descricao" class="block text-sm font-medium text-gray-700 mb-1">
                        Descrição Detalhada <span class="text-danger">*</span>
                    </label>
                    <textarea 
                        id="epi-descricao" 
                        required 
                        rows="3" 
                        placeholder="Descreva as características do EPI..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    ></textarea>
                </div>
                
                <div class="flex justify-end pt-4 border-t">
                    <button 
                        type="button" 
                        onclick="fecharModalCadastro()" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 mr-2 hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90"
                    >
                        <i class="fas fa-save mr-2"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Cadastro/Edição de Centro de Custo -->
    <div id="modal-centro" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="modal-titulo-centro" class="text-xl font-bold text-gray-800">Cadastrar Novo Centro de Custo</h2>
                <button onclick="fecharModal('modal-centro')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="form-centro" class="p-4">
                <input type="hidden" id="centro-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Código -->
                    <div>
                        <label for="centro-codigo" class="block text-sm font-medium text-gray-700 mb-1">
                            Código <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="centro-codigo" 
                            required 
                            placeholder="Ex: CC001" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Contrato -->
                    <div>
                        <label for="centro-nome" class="block text-sm font-medium text-gray-700 mb-1">
                            Contrato <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="centro-nome" 
                            required 
                            placeholder="Ex: Construção Ponte Rio-Niterói" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Responsável -->
                    <div>
                        <label for="centro-responsavel" class="block text-sm font-medium text-gray-700 mb-1">
                            Responsável <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="centro-responsavel" 
                            required 
                            placeholder="Ex: João Silva" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Setor -->
                    <div>
                        <label for="centro-departamento" class="block text-sm font-medium text-gray-700 mb-1">
                            Setor <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="centro-departamento" 
                            required 
                            placeholder="Ex: Operacional" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Status -->
                    <div>
                        <label for="centro-status" class="block text-sm font-medium text-gray-700 mb-1">
                            Status <span class="text-danger">*</span>
                        </label>
                        <select 
                            id="centro-status" 
                            required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base appearance-none"
                        >
                            <option value="Ativo">Ativo</option>
                            <option value="Inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                
                <!-- Observações -->
                <div class="mb-4">
                    <label for="centro-observacoes" class="block text-sm font-medium text-gray-700 mb-1">
                        Observações
                    </label>
                    <textarea 
                        id="centro-observacoes" 
                        rows="3" 
                        placeholder="Informações adicionais sobre o centro de custo..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    ></textarea>
                </div>
                
                <div class="flex justify-end pt-4 border-t">
                    <button 
                        type="button" 
                        onclick="fecharModal('modal-centro')" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 mr-2 hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90"
                    >
                        <i class="fas fa-save mr-2"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Cadastro/Edição de Provisionamento -->
    <div id="modal-provisao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="modal-titulo-provisao" class="text-xl font-bold text-gray-800">Cadastrar Novo Provisionamento</h2>
                <button onclick="fecharModal('modal-provisao')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="form-provisao" class="p-4 max-h-[70vh] overflow-y-auto">
                <input type="hidden" id="provisao-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Centro de Custo -->
                    <div>
                        <label for="provisao-centro" class="block text-sm font-medium text-gray-700 mb-1">
                            Centro de Custo <span class="text-danger">*</span>
                        </label>
                        <select 
                            id="provisao-centro" 
                            required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base appearance-none"
                        >
                            <option value="">Selecione um centro de custo</option>
                            <!-- Será preenchido via JavaScript -->
                        </select>
                    </div>
                    
                    <!-- Mês/Ano de Referência -->
                    <div>
                        <label for="provisao-mes-ano" class="block text-sm font-medium text-gray-700 mb-1">
                            Mês/Ano de Referência <span class="text-danger">*</span>
                        </label>
                        <select 
                            id="provisao-mes-ano" 
                            required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base appearance-none"
                        >
                            <option value="">Selecione o mês/ano</option>
                            <option value="01/2024">Janeiro/2024</option>
                            <option value="02/2024">Fevereiro/2024</option>
                            <option value="03/2024">Março/2024</option>
                            <option value="04/2024">Abril/2024</option>
                            <option value="05/2024">Maio/2024</option>
                            <option value="06/2024">Junho/2024</option>
                            <option value="07/2024">Julho/2024</option>
                            <option value="08/2024">Agosto/2024</option>
                            <option value="09/2024">Setembro/2024</option>
                            <option value="10/2024">Outubro/2024</option>
                            <option value="11/2024">Novembro/2024</option>
                            <option value="12/2024">Dezembro/2024</option>
                        </select>
                    </div>
                    
                    <!-- Responsável -->
                    <div>
                        <label for="provisao-responsavel" class="block text-sm font-medium text-gray-700 mb-1">
                            Responsável <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="provisao-responsavel" 
                            required 
                            placeholder="Ex: Maria Silva" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Status -->
                    <div>
                        <label for="provisao-status" class="block text-sm font-medium text-gray-700 mb-1">
                            Status <span class="text-danger">*</span>
                        </label>
                        <select 
                            id="provisao-status" 
                            required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base appearance-none"
                        >
                            <option value="Solicitado">Solicitado</option>
                            <option value="Aprovado">Aprovado</option>
                            <option value="Rejeitado">Rejeitado</option>
                        </select>
                    </div>
                </div>
                
                <!-- Justificativa -->
                <div class="mb-6">
                    <label for="provisao-justificativa" class="block text-sm font-medium text-gray-700 mb-1">
                        Justificativa <span class="text-danger">*</span>
                    </label>
                    <textarea 
                        id="provisao-justificativa" 
                        required 
                        rows="2" 
                        placeholder="Explique o motivo deste provisionamento..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    ></textarea>
                </div>
                
                <!-- Itens do Provisionamento -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-medium text-gray-800">Itens Solicitados</h3>
                        <button 
                            type="button"
                            onclick="adicionarItemProvisao()"
                            class="bg-primary text-white px-3 py-1 rounded text-sm hover:bg-primary/90"
                        >
                            <i class="fas fa-plus mr-1"></i> Adicionar Item
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 mb-2">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">EPI</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Quantidade</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Valor Unitário</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Valor Total</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-itens-provisao" class="bg-white divide-y divide-gray-200">
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                            <tfoot class="bg-gray-50">
                                <tr>
                                    <td colspan="3" class="px-4 py-2 text-right font-medium">Total:</td>
                                    <td id="provisao-valor-total" class="px-4 py-2 font-medium">R$ 0,00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div id="sem-itens-provisao" class="text-center p-4 text-gray-500">
                        Nenhum item adicionado. Clique em "Adicionar Item" para incluir EPIs no provisionamento.
                    </div>
                </div>
                
                <!-- Observações -->
                <div class="mb-4">
                    <label for="provisao-observacoes" class="block text-sm font-medium text-gray-700 mb-1">
                        Observações
                    </label>
                    <textarea 
                        id="provisao-observacoes" 
                        rows="2" 
                        placeholder="Informações adicionais sobre a solicitação..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    ></textarea>
                </div>
                
                <div class="flex justify-end pt-4 border-t">
                    <button 
                        type="button" 
                        onclick="fecharModal('modal-provisao')" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 mr-2 hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        class="px-4 py-2 bg-info text-white rounded-md hover:bg-info/90"
                    >
                        <i class="fas fa-save mr-2"></i> Salvar Provisionamento
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para adicionar item ao provisionamento -->
    <div id="modal-adicionar-item" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-lg font-medium text-gray-800">Adicionar Item ao Provisionamento</h2>
                <button onclick="fecharModal('modal-adicionar-item')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="form-item-provisao" class="p-4">
                <div class="mb-4">
                    <label for="item-epi" class="block text-sm font-medium text-gray-700 mb-1">
                        EPI <span class="text-danger">*</span>
                    </label>
                    <select 
                        id="item-epi" 
                        required 
                        onchange="atualizarValorItem()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base appearance-none"
                    >
                        <option value="">Selecione um EPI</option>
                        <!-- Será preenchido via JavaScript -->
                    </select>
                </div>
                
                <div class="mb-4">
                    <label for="item-quantidade" class="block text-sm font-medium text-gray-700 mb-1">
                        Quantidade <span class="text-danger">*</span>
                    </label>
                    <input 
                        type="number" 
                        id="item-quantidade" 
                        required 
                        min="1" 
                        value="1" 
                        onchange="atualizarValorItem()"
                        oninput="atualizarValorItem()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    >
                </div>
                
                <div class="mb-4">
                    <label for="item-valor" class="block text-sm font-medium text-gray-700 mb-1">
                        Valor Unitário (R$)
                    </label>
                    <input 
                        type="number" 
                        id="item-valor" 
                        min="0" 
                        step="0.01" 
                        readonly 
                        class="w-full px-3 py-2 border border-gray-200 bg-gray-50 rounded-md text-base"
                    >
                    <p class="text-xs text-gray-500 mt-1" id="item-valor-info">
                        Valor baseado no custo atual do EPI selecionado
                    </p>
                </div>
                
                <div class="flex justify-end pt-4 border-t">
                    <button 
                        type="button" 
                        onclick="fecharModal('modal-adicionar-item')" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 mr-2 hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90"
                    >
                        <i class="fas fa-plus mr-2"></i> Adicionar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Detalhes do Provisionamento -->
    <div id="modal-detalhes-provisao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-4xl mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="detalhes-provisao-titulo" class="text-xl font-bold text-gray-800">Detalhes do Provisionamento</h2>
                <button onclick="fecharModal('modal-detalhes-provisao')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 max-h-[70vh] overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <!-- Informações básicas -->
                    <div>
                        <p class="text-sm text-gray-500">Centro de Custo:</p>
                        <p id="detalhes-provisao-centro" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Data da Solicitação:</p>
                        <p id="detalhes-provisao-data" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Mês/Ano de Referência:</p>
                        <p id="detalhes-provisao-mes-ano" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Responsável:</p>
                        <p id="detalhes-provisao-responsavel" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Status:</p>
                        <p id="detalhes-provisao-status" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Valor Total:</p>
                        <p id="detalhes-provisao-valor" class="font-medium"></p>
                    </div>
                </div>
                
                <!-- Justificativa -->
                <div class="mb-6">
                    <p class="text-sm text-gray-500">Justificativa:</p>
                    <p id="detalhes-provisao-justificativa" class="mt-1"></p>
                </div>
                
                <!-- Lista de Itens -->
                <div class="mb-6">
                    <h3 class="text-lg font-medium text-gray-800 mb-3">Itens Solicitados</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">EPI</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Quantidade</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Valor Unitário</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Valor Total</th>
                                </tr>
                            </thead>
                            <tbody id="detalhes-provisao-itens" class="bg-white divide-y divide-gray-200">
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                            <tfoot class="bg-gray-50">
                                <tr>
                                    <td colspan="3" class="px-4 py-2 text-right font-medium">Total:</td>
                                    <td id="detalhes-provisao-total" class="px-4 py-2 font-medium"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                
                <!-- Observações -->
                <div class="mb-6">
                    <p class="text-sm text-gray-500">Observações:</p>
                    <p id="detalhes-provisao-observacoes" class="mt-1"></p>
                </div>
                
                <!-- Ações -->
                <div class="flex justify-end pt-4 border-t gap-2">
                    <button 
                        type="button" 
                        onclick="fecharModal('modal-detalhes-provisao')" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                    >
                        Fechar
                    </button>
                    <button 
                        type="button" 
                        id="btn-editar-provisao" 
                        class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90"
                    >
                        <i class="fas fa-edit mr-2"></i> Editar
                    </button>
                    <button 
                        type="button" 
                        id="btn-aprovar-provisao" 
                        class="px-4 py-2 bg-success text-white rounded-md hover:bg-success/90"
                    >
                        <i class="fas fa-check-circle mr-2"></i> Aprovar
                    </button>
                    <button 
                        type="button" 
                        id="btn-rejeitar-provisao" 
                        class="px-4 py-2 bg-danger text-white rounded-md hover:bg-danger/90"
                    >
                        <i class="fas fa-times-circle mr-2"></i> Rejeitar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Entrada de Estoque -->
    <div id="modal-entrada" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">Registrar Entrada de Estoque</h2>
                <button onclick="fecharModal('modal-entrada')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="form-entrada" class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Seleção de EPI -->
                    <div class="md:col-span-2">
                        <label for="entrada-epi" class="block text-sm font-medium text-gray-700 mb-1">
                            EPI <span class="text-danger">*</span>
                        </label>
                        <select 
                            id="entrada-epi" 
                            required 
                            onchange="atualizarInfoEPI(this.value, 'entrada')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base appearance-none"
                        >
                            <option value="">Selecione um EPI</option>
                            <!-- Opções serão preenchidas via JavaScript -->
                        </select>
                        <p id="entrada-estoque-info" class="text-xs text-gray-500 mt-1">Estoque atual: -</p>
                    </div>
                    
                    <!-- Quantidade -->
                    <div>
                        <label for="entrada-quantidade" class="block text-sm font-medium text-gray-700 mb-1">
                            Quantidade <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="entrada-quantidade" 
                            required 
                            min="1" 
                            placeholder="Ex: 50" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Custo Unitário -->
                    <div>
                        <label for="entrada-custo" class="block text-sm font-medium text-gray-700 mb-1">
                            Custo Unitário (R$) <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="entrada-custo" 
                            required 
                            min="0" 
                            step="0.01" 
                            placeholder="Ex: 35.90" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                        <p id="entrada-custo-info" class="text-xs text-gray-500 mt-1">Custo atual: -</p>
                    </div>
                    
                    <!-- Data da Entrada -->
                    <div>
                        <label for="entrada-data" class="block text-sm font-medium text-gray-700 mb-1">
                            Data <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="entrada-data" 
                            required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Nota Fiscal -->
                    <div>
                        <label for="entrada-nota-fiscal" class="block text-sm font-medium text-gray-700 mb-1">
                            Nota Fiscal
                        </label>
                        <input 
                            type="text" 
                            id="entrada-nota-fiscal" 
                            placeholder="Ex: NF-e 12345" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Fornecedor -->
                    <div>
                        <label for="entrada-fornecedor" class="block text-sm font-medium text-gray-700 mb-1">
                            Fornecedor
                        </label>
                        <input 
                            type="text" 
                            id="entrada-fornecedor" 
                            placeholder="Ex: 3M Brasil" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Responsável -->
                    <div>
                        <label for="entrada-responsavel" class="block text-sm font-medium text-gray-700 mb-1">
                            Responsável <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="entrada-responsavel" 
                            required 
                            placeholder="Ex: João Silva" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                </div>
                
                <!-- Observações -->
                <div class="mb-4">
                    <label for="entrada-observacoes" class="block text-sm font-medium text-gray-700 mb-1">
                        Observações
                    </label>
                    <textarea 
                        id="entrada-observacoes" 
                        rows="2" 
                        placeholder="Informações adicionais sobre a entrada..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    ></textarea>
                </div>
                
                <div class="flex justify-end pt-4 border-t">
                    <button 
                        type="button" 
                        onclick="fecharModal('modal-entrada')" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 mr-2 hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        class="px-4 py-2 bg-success text-white rounded-md hover:bg-success/90"
                    >
                        <i class="fas fa-save mr-2"></i> Registrar Entrada
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Saída de Estoque -->
    <div id="modal-saida" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">Registrar Saída de Estoque</h2>
                <button onclick="fecharModal('modal-saida')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="form-saida" class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <!-- Seleção de EPI -->
                    <div class="md:col-span-2">
                        <label for="saida-epi" class="block text-sm font-medium text-gray-700 mb-1">
                            EPI <span class="text-danger">*</span>
                        </label>
                        <select 
                            id="saida-epi" 
                            required 
                            onchange="atualizarInfoEPI(this.value, 'saida')"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base appearance-none"
                        >
                            <option value="">Selecione um EPI</option>
                            <!-- Opções serão preenchidas via JavaScript -->
                        </select>
                        <p id="saida-estoque-info" class="text-xs text-gray-500 mt-1">Estoque disponível: -</p>
                    </div>
                    
                    <!-- Quantidade -->
                    <div>
                        <label for="saida-quantidade" class="block text-sm font-medium text-gray-700 mb-1">
                            Quantidade <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="number" 
                            id="saida-quantidade" 
                            required 
                            min="1" 
                            placeholder="Ex: 10" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Data da Saída -->
                    <div>
                        <label for="saida-data" class="block text-sm font-medium text-gray-700 mb-1">
                            Data <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="saida-data" 
                            required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Centro de Custo -->
                    <div>
                        <label for="saida-centro-custo" class="block text-sm font-medium text-gray-700 mb-1">
                            Centro de Custo <span class="text-danger">*</span>
                        </label>
                        <select 
                            id="saida-centro-custo" 
                            required 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base appearance-none"
                        >
                            <option value="">Selecione um centro de custo</option>
                            <!-- Opções serão preenchidas via JavaScript -->
                        </select>
                    </div>
                    
                    <!-- Destino/Setor -->
                    <div>
                        <label for="saida-destino" class="block text-sm font-medium text-gray-700 mb-1">
                            Destino/Setor <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="saida-destino" 
                            required
                            placeholder="Ex: Linha de Produção A" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Responsável -->
                    <div>
                        <label for="saida-responsavel" class="block text-sm font-medium text-gray-700 mb-1">
                            Responsável pela Retirada <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="saida-responsavel" 
                            required 
                            placeholder="Ex: Maria Oliveira" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                    
                    <!-- Funcionário Destinatário -->
                    <div>
                        <label for="saida-funcionario" class="block text-sm font-medium text-gray-700 mb-1">
                            Funcionário Destinatário <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="saida-funcionario" 
                            required 
                            placeholder="Ex: José Almeida" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                        >
                    </div>
                </div>
                
                <!-- Motivo/Finalidade -->
                <div class="mb-4">
                    <label for="saida-motivo" class="block text-sm font-medium text-gray-700 mb-1">
                        Motivo/Finalidade <span class="text-danger">*</span>
                    </label>
                    <textarea 
                        id="saida-motivo" 
                        required
                        rows="2" 
                        placeholder="Informe o motivo ou finalidade da retirada..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    ></textarea>
                </div>
                
                <div class="flex justify-end pt-4 border-t">
                    <button 
                        type="button" 
                        onclick="fecharModal('modal-saida')" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 mr-2 hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        class="px-4 py-2 bg-warning text-white rounded-md hover:bg-warning/90"
                    >
                        <i class="fas fa-save mr-2"></i> Registrar Saída
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Visualização -->
    <div id="modal-visualizacao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-3xl mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="visualizacao-titulo" class="text-xl font-bold text-gray-800">Detalhes do EPI</h2>
                <button onclick="fecharModal('modal-visualizacao')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 max-h-[70vh] overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-gray-500">Nome:</p>
                        <p id="visualizacao-nome" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Código:</p>
                        <p id="visualizacao-codigo" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Categoria:</p>
                        <p id="visualizacao-categoria" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Unidade de Medida:</p>
                        <p id="visualizacao-unidade" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Estoque Atual:</p>
                        <p id="visualizacao-estoque" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Estoque Mínimo:</p>
                        <p id="visualizacao-estoque-minimo" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Custo Unitário:</p>
                        <p id="visualizacao-custo" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Número do CA:</p>
                        <p id="visualizacao-ca" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Fornecedor:</p>
                        <p id="visualizacao-fornecedor" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Validade:</p>
                        <p id="visualizacao-validade" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Localização:</p>
                        <p id="visualizacao-localizacao" class="font-medium"></p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Status:</p>
                        <p id="visualizacao-status" class="font-medium"></p>
                    </div>
                </div>
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Descrição:</p>
                    <p id="visualizacao-descricao" class="mt-1"></p>
                </div>
                <div class="flex justify-end pt-4 border-t">
                    <button 
                        type="button" 
                        onclick="fecharModal('modal-visualizacao')" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 mr-2 hover:bg-gray-50"
                    >
                        Fechar
                    </button>
                    <button 
                        type="button" 
                        id="btn-editar" 
                        class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90"
                    >
                        <i class="fas fa-edit mr-2"></i> Editar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes de Entrada/Saída -->
    <div id="modal-detalhes-movimentacao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="detalhes-movimentacao-titulo" class="text-xl font-bold text-gray-800">Detalhes da Movimentação</h2>
                <button onclick="fecharModal('modal-detalhes-movimentacao')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="detalhes-movimentacao-conteudo" class="p-4">
                <!-- O conteúdo será preenchido via JavaScript -->
            </div>
            <div class="p-4 border-t flex justify-end">
                <button 
                    type="button" 
                    onclick="fecharModal('modal-detalhes-movimentacao')" 
                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                >
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro de Usuário -->
    <div id="modal-cadastro-usuario" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">Cadastro de Novo Usuário</h2>
                <button onclick="fecharModal('modal-cadastro-usuario')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="form-cadastro-usuario" class="p-4">
                <div class="mb-4">
                    <label for="cadastro-nome" class="block text-sm font-medium text-gray-700 mb-1">
                        Nome Completo <span class="text-danger">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="cadastro-nome" 
                        required 
                        placeholder="Digite seu nome completo"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    >
                </div>
                
                <div class="mb-4">
                    <label for="cadastro-login" class="block text-sm font-medium text-gray-700 mb-1">
                        Nome de Usuário <span class="text-danger">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="cadastro-login" 
                        required 
                        placeholder="Digite um nome de usuário"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    >
                </div>
                
                <div class="mb-4">
                    <label for="cadastro-senha" class="block text-sm font-medium text-gray-700 mb-1">
                        Senha <span class="text-danger">*</span>
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="cadastro-senha" 
                            required 
                            placeholder="Digite uma senha segura"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base pr-10"
                        >
                        <button 
                            type="button" 
                            onclick="toggleSenhaCadastro()"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 text-gray-500"
                        >
                            <i class="fas fa-eye" id="icone-senha-cadastro"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Mínimo de 6 caracteres</p>
                </div>
                
                <div class="mb-4">
                    <label for="cadastro-confirmar-senha" class="block text-sm font-medium text-gray-700 mb-1">
                        Confirmar Senha <span class="text-danger">*</span>
                    </label>
                    <input 
                        type="password" 
                        id="cadastro-confirmar-senha" 
                        required 
                        placeholder="Confirme sua senha"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    >
                </div>
                
                <div id="erro-cadastro" class="hidden text-danger text-sm bg-red-50 p-2 rounded mb-4"></div>
                
                <div class="flex justify-end pt-4 border-t">
                    <button 
                        type="button" 
                        onclick="fecharModal('modal-cadastro-usuario')" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 mr-2 hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90"
                    >
                        <i class="fas fa-user-plus mr-2"></i> Cadastrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div id="modal-confirmacao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
            <div class="text-center mb-4">
                <div class="mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-red-100 mb-4">
                    <i class="fas fa-exclamation-triangle text-danger text-xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Confirmar Exclusão</h3>
                <p class="text-gray-500 mt-2" id="confirmacao-texto">
                    Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.
                </p>
            </div>
            <div class="flex justify-center">
                <button 
                    type="button" 
                    onclick="fecharModal('modal-confirmacao')" 
                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 mr-2 hover:bg-gray-50"
                >
                    Cancelar
                </button>
                <button 
                    type="button" 
                    id="btn-confirmar-exclusao" 
                    class="px-4 py-2 bg-danger text-white rounded-md hover:bg-danger/90"
                >
                    <i class="fas fa-trash-alt mr-2"></i> Excluir
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Atualização de Custo -->
    <div id="modal-confirmar-custo" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
            <div class="text-center mb-4">
                <div class="mx-auto w-12 h-12 flex items-center justify-center rounded-full bg-yellow-100 mb-4">
                    <i class="fas fa-question-circle text-warning text-xl"></i>
                </div>
                <h3 class="text-lg font-medium text-gray-900">Atualizar Custo do EPI?</h3>
                <p class="text-gray-500 mt-2" id="confirmacao-custo-texto">
                    O custo unitário informado (R$ <span id="novo-custo"></span>) é diferente do valor atual (R$ <span id="custo-atual"></span>).
                    Deseja atualizar o valor do custo unitário no cadastro do EPI?
                </p>
            </div>
            <div class="flex justify-center">
                <button 
                    type="button" 
                    id="btn-manter-custo" 
                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 mr-2 hover:bg-gray-50"
                >
                    Manter Valor Atual
                </button>
                <button 
                    type="button" 
                    id="btn-atualizar-custo" 
                    class="px-4 py-2 bg-warning text-white rounded-md hover:bg-warning/90"
                >
                    <i class="fas fa-check mr-2"></i> Atualizar Valor
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro/Edição de Usuário -->
    <div id="modal-usuario" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4">
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="modal-titulo-usuario" class="text-xl font-bold text-gray-800">Novo Usuário</h2>
                <button onclick="fecharModal('modal-usuario')" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="form-usuario" class="p-4">
                <input type="hidden" id="usuario-id">
                
                <div class="mb-4">
                    <label for="usuario-nome" class="block text-sm font-medium text-gray-700 mb-1">
                        Nome Completo <span class="text-danger">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="usuario-nome" 
                        required 
                        placeholder="Ex: João da Silva"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    >
                </div>
                
                <div class="mb-4">
                    <label for="usuario-login" class="block text-sm font-medium text-gray-700 mb-1">
                        Nome de Usuário <span class="text-danger">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="usuario-login" 
                        required 
                        placeholder="Ex: joao.silva"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    >
                </div>
                
                <div id="div-senha" class="mb-4">
                    <label for="usuario-senha" class="block text-sm font-medium text-gray-700 mb-1">
                        Senha <span class="text-danger">*</span>
                    </label>
                    <div class="relative">
                        <input 
                            type="password" 
                            id="usuario-senha" 
                            required 
                            placeholder="Digite uma senha segura"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-base pr-10"
                        >
                        <button 
                            type="button" 
                            onclick="toggleSenha()"
                            class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5 text-gray-500"
                        >
                            <i class="fas fa-eye" id="icone-senha"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Mínimo de 6 caracteres</p>
                </div>
                
                <div class="mb-4">
                    <label for="usuario-perfil" class="block text-sm font-medium text-gray-700 mb-1">
                        Perfil <span class="text-danger">*</span>
                    </label>
                    <select 
                        id="usuario-perfil" 
                        required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    >
                        <option value="">Selecione um perfil</option>
                        <option value="Administrador">Administrador</option>
                        <option value="Operador">Operador</option>
                        <option value="Visualizador">Visualizador</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        <span class="font-medium">Administrador:</span> Acesso completo<br>
                        <span class="font-medium">Operador:</span> Gerencia estoque e registros<br>
                        <span class="font-medium">Visualizador:</span> Apenas visualiza dados
                    </p>
                </div>
                
                <div class="mb-4">
                    <label for="usuario-status" class="block text-sm font-medium text-gray-700 mb-1">
                        Status <span class="text-danger">*</span>
                    </label>
                    <select 
                        id="usuario-status" 
                        required 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-base"
                    >
                        <option value="Ativo">Ativo</option>
                        <option value="Inativo">Inativo</option>
                    </select>
                </div>
                
                <div class="flex justify-end pt-4 border-t">
                    <button 
                        type="button" 
                        onclick="fecharModal('modal-usuario')" 
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 mr-2 hover:bg-gray-50"
                    >
                        Cancelar
                    </button>
                    <button 
                        type="submit" 
                        class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90"
                    >
                        <i class="fas fa-save mr-2"></i> Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast de notificação -->
    <div id="toast" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-y-20 opacity-0">
        <div class="flex items-center">
            <i id="toast-icon" class="mr-2"></i>
            <span id="toast-mensagem"></span>
        </div>
    </div>

    <script>
        // Funções para exportação e importação de dados
        // Função para exportar todos os dados para um arquivo JSON
        function exportarDados() {
            // Criar objeto com todos os dados do sistema
            const dados = {
                epis: listaEPIs,
                entradas: listaEntradas,
                saidas: listaSaidas,
                centros: listaCentros,
                provisoes: listaProvisoes,
                usuarios: listaUsuarios,
                dataExportacao: new Date().toISOString()
            };
            
            // Converter para string JSON
            const jsonString = JSON.stringify(dados, null, 2);
            
            // Criar um blob com os dados
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            // Criar URL para o blob
            const url = URL.createObjectURL(blob);
            
            // Data atual formatada para o nome do arquivo
            const dataFormatada = new Date().toISOString().split('T')[0];
            
            // Criar um elemento de link para download
            const a = document.createElement('a');
            a.href = url;
            a.download = `sistema-epis-backup-${dataFormatada}.json`;
            
            // Adicionar à página, clicar e remover
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Liberar a URL
            URL.revokeObjectURL(url);
            
            mostrarToast('Dados exportados com sucesso!', 'sucesso');
        }

        // Função para importar dados a partir de um arquivo JSON
        function importarDados(evento) {
            const arquivo = evento.target.files[0];
            if (!arquivo) return;
            
            const leitor = new FileReader();
            
            leitor.onload = function(e) {
                try {
                    const dados = JSON.parse(e.target.result);
                    
                    // Validar se o arquivo tem o formato esperado
                    if (!dados.epis || !dados.entradas || !dados.saidas || 
                        !dados.centros || !dados.provisoes) {
                        throw new Error('Formato de arquivo inválido');
                    }
                    
                    // Confirmar com o usuário
                    if (confirm('ATENÇÃO: Todos os dados atuais serão substituídos pelos dados importados. Deseja continuar?')) {
                        // Atualizar todas as listas
                        listaEPIs = dados.epis;
                        listaEntradas = dados.entradas;
                        listaSaidas = dados.saidas;
                        listaCentros = dados.centros;
                        listaProvisoes = dados.provisoes;
                        
                        // Usuários (opcional - pode querer manter os usuários atuais)
                        if (dados.usuarios && confirm('Deseja também importar os usuários?')) {
                            listaUsuarios = dados.usuarios;
                        }
                        
                        // Recarregar dados na interface
                        mudarTab('epis');
                        
                        mostrarToast('Dados importados com sucesso!', 'sucesso');
                    }
                } catch (erro) {
                    mostrarToast(`Erro ao importar dados: ${erro.message}`, 'erro');
                    console.error('Erro ao importar dados:', erro);
                }
                
                // Limpar o campo de arquivo
                document.getElementById('input-importar').value = '';
            };
            
            leitor.readAsText(arquivo);
        }
        
        // Dados dos usuários
        let listaUsuarios = [
            {
                id: 1,
                nome: 'Administrador do Sistema',
                login: 'admin',
                senha: 'admin123',
                perfil: 'Administrador',
                status: 'Ativo',
                ultimoAcesso: '2024-04-10 09:45'
            },
            {
                id: 2,
                nome: 'Operador Padrão',
                login: 'operador',
                senha: 'operador123',
                perfil: 'Operador',
                status: 'Ativo',
                ultimoAcesso: '2024-04-08 14:30'
            },
            {
                id: 3,
                nome: 'Usuário Visitante',
                login: 'visitante',
                senha: 'visitante123',
                perfil: 'Visualizador',
                status: 'Ativo',
                ultimoAcesso: null
            }
        ];

        // Usuário atual logado
        let usuarioAtual = null;

        // Dados dos EPIs
        let listaEPIs = [
            {
                id: 1,
                nome: 'Capacete de Segurança Classe B',
                codigo: 'EPI001',
                categoria: 'Capacetes',
                unidade: 'Unidade',
                estoque: 45,
                estoqueMinimo: 20,
                custo: 35.90,
                ca: '31469',
                fornecedor: '3M',
                validade: '2025-06-30',
                localizacao: 'Prateleira A1, Estante 2',
                descricao: 'Capacete de segurança com aba frontal, confeccionado em polietileno de alta densidade.'
            },
            {
                id: 2,
                nome: 'Luva de Proteção contra Agentes Químicos',
                codigo: 'EPI002',
                categoria: 'Luvas',
                unidade: 'Par',
                estoque: 120,
                estoqueMinimo: 50,
                custo: 12.75,
                ca: '37532',
                fornecedor: 'Mucambo',
                validade: '2024-12-15',
                localizacao: 'Prateleira C3, Estante 4',
                descricao: 'Luva de látex natural, forrada internamente com flocos de algodão, palma antiderrapante.'
            },
            {
                id: 3,
                nome: 'Óculos de Proteção Incolor',
                codigo: 'EPI003',
                categoria: 'Óculos',
                unidade: 'Unidade',
                estoque: 18,
                estoqueMinimo: 25,
                custo: 9.50,
                ca: '19072',
                fornecedor: 'MSA',
                validade: '2026-03-22',
                localizacao: 'Prateleira B2, Estante 1',
                descricao: 'Óculos de segurança com lente em policarbonato incolor, tratamento anti-risco e antiembaçante.'
            }
        ];

        // Dados de entradas de estoque
        let listaEntradas = [
            {
                id: 1,
                epiId: 1,
                data: '2024-01-15',
                quantidade: 20,
                custo: 35.90,
                notaFiscal: 'NF-e 12345',
                fornecedor: '3M Brasil',
                responsavel: 'João Silva',
                observacoes: 'Lote recebido em perfeitas condições.'
            },
            {
                id: 2,
                epiId: 2,
                data: '2024-01-20',
                quantidade: 50,
                custo: 12.75,
                notaFiscal: 'NF-e 23456',
                fornecedor: 'Mucambo Ltda',
                responsavel: 'Maria Santos',
                observacoes: 'Reposição de estoque.'
            }
        ];

        // Dados de saídas de estoque
        let listaSaidas = [
            {
                id: 1,
                epiId: 1,
                data: '2024-01-25',
                quantidade: 5,
                centroCustoId: 1,
                destino: 'Linha de Montagem',
                responsavel: 'Carlos Oliveira',
                funcionario: 'Pedro Ferreira',
                motivo: 'Reposição de EPIs para equipe de montagem.'
            },
            {
                id: 2,
                epiId: 2,
                data: '2024-01-28',
                quantidade: 10,
                centroCustoId: 2,
                destino: 'Setor de Manutenção Elétrica',
                responsavel: 'Ana Souza',
                funcionario: 'Roberto Almeida',
                motivo: 'Substituição de EPIs danificados.'
            },
            {
                id: 3,
                epiId: 1,
                data: '2024-02-03',
                quantidade: 2,
                centroCustoId: 3,
                destino: 'Equipe de Manutenção',
                responsavel: 'Paulo Torres',
                funcionario: 'Marcos Silva',
                motivo: 'EPIs para novos colaboradores.'
            },
            {
                id: 4,
                epiId: 3,
                data: '2024-02-05',
                quantidade: 8,
                centroCustoId: 1,
                destino: 'Área de Solda',
                responsavel: 'Carlos Oliveira',
                funcionario: 'Paulo Henrique',
                motivo: 'Proteção para trabalhos de solda.'
            },
            {
                id: 5,
                epiId: 2,
                data: '2024-02-10',
                quantidade: 6,
                centroCustoId: 2,
                destino: 'Área de Pintura',
                responsavel: 'Ana Souza',
                funcionario: 'Juliana Martins',
                motivo: 'Proteção para manuseio de produtos químicos.'
            }
        ];

        // Dados dos Centros de Custo
        let listaCentros = [
            {
                id: 1,
                codigo: 'CC001',
                nome: 'Obra Ponte Rio-Niterói',
                responsavel: 'Roberto Almeida',
                departamento: 'Obras Externas',
                status: 'Ativo',
                observacoes: 'Centro de custo responsável pela obra de construção da ponte.'
            },
            {
                id: 2,
                codigo: 'CC002',
                nome: 'Reforma Aeroporto Santos Dumont',
                responsavel: 'Carla Ferreira',
                departamento: 'Reformas',
                status: 'Ativo',
                observacoes: 'Responsável pelas atividades de reforma do terminal 2.'
            },
            {
                id: 3,
                codigo: 'CC003',
                nome: 'Manutenção Predial - Sede',
                responsavel: 'Paulo Soares',
                departamento: 'Manutenção',
                status: 'Ativo',
                observacoes: 'Manutenção preventiva e corretiva no prédio sede.'
            }
        ];
        
        // Dados de provisionamentos
        let listaProvisoes = [
            {
                id: 1,
                centroCustoId: 1,
                dataSolicitacao: '2024-01-10',
                mesAnoReferencia: '02/2024',
                responsavel: 'Roberto Almeida',
                status: 'Aprovado',
                justificativa: 'Provisionamento de EPIs para fase de fundações da obra da ponte.',
                observacoes: 'Incluir alguns EPIs extras para visitantes da obra.',
                itens: [
                    {
                        id: 1,
                        epiId: 1,
                        quantidade: 15,
                        valorUnitario: 35.90
                    },
                    {
                        id: 2,
                        epiId: 3,
                        quantidade: 30,
                        valorUnitario: 9.50
                    }
                ]
            },
            {
                id: 2,
                centroCustoId: 2,
                dataSolicitacao: '2024-01-15',
                mesAnoReferencia: '02/2024',
                responsavel: 'Carla Ferreira',
                status: 'Solicitado',
                justificativa: 'EPIs necessários para reforma do terminal 2 do aeroporto.',
                observacoes: 'Prioridade alta devido ao prazo da obra.',
                itens: [
                    {
                        id: 3,
                        epiId: 1,
                        quantidade: 8,
                        valorUnitario: 35.90
                    },
                    {
                        id: 4,
                        epiId: 2,
                        quantidade: 20,
                        valorUnitario: 12.75
                    }
                ]
            },
            {
                id: 3,
                centroCustoId: 3,
                dataSolicitacao: '2024-01-20',
                mesAnoReferencia: '03/2024',
                responsavel: 'Paulo Soares',
                status: 'Rejeitado',
                justificativa: 'Manutenção preventiva nos sistemas elétricos do prédio sede.',
                observacoes: 'Rejeitado por duplicidade. Favor revisar as quantidades e submeter novamente.',
                itens: [
                    {
                        id: 5,
                        epiId: 2,
                        quantidade: 5,
                        valorUnitario: 12.75
                    }
                ]
            }
        ];

        let epiAtual = null;
        let entradaAtual = null;
        let saidaAtual = null;
        let centroAtual = null;
        let provisaoAtual = null;
        let atualizarCusto = false;
        let itensProvisao = [];
        let graficoPorCentro = null;
        let graficoPorCategoria = null;

        // Formatar valor monetário
        function formatarMoeda(valor) {
            return `R$ ${valor.toFixed(2).replace('.', ',')}`;
        }

        // Formatar data
        function formatarData(data) {
            if (!data) return '-';
            const partes = data.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        }

        // Mostrar toast de notificação
        function mostrarToast(mensagem, tipo) {
            const toast = document.getElementById('toast');
            const toastIcon = document.getElementById('toast-icon');
            const toastMensagem = document.getElementById('toast-mensagem');
            
            if (tipo === 'sucesso') {
                toast.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg bg-success/10 text-success';
                toastIcon.className = 'fas fa-check-circle mr-2';
            } else if (tipo === 'erro') {
                toast.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg bg-danger/10 text-danger';
                toastIcon.className = 'fas fa-exclamation-circle mr-2';
            } else if (tipo === 'aviso') {
                toast.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg bg-warning/10 text-warning';
                toastIcon.className = 'fas fa-exclamation-triangle mr-2';
            } else {
                toast.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg bg-info/10 text-info';
                toastIcon.className = 'fas fa-info-circle mr-2';
            }
            
            toastMensagem.textContent = mensagem;
            
            // Mostrar o toast
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            // Esconder o toast após 3 segundos
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Abrir modal - com verificação de segurança
        function abrirModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('hidden');
            } else {
                console.error(`Modal com ID "${id}" não encontrado`);
                mostrarToast(`Erro: Não foi possível abrir a janela solicitada (${id})`, 'erro');
            }
        }

        // Fechar modal - com verificação de segurança
        function fecharModal(id) {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.add('hidden');
            } else {
                console.error(`Modal com ID "${id}" não encontrado`);
                // Não exibe toast aqui para não incomodar o usuário ao fechar algo que já não está visível
            }
        }

        // Mudar aba
        function mudarTab(tab) {
            // Esconder todas as abas
            document.getElementById('conteudo-epis').classList.add('hidden');
            document.getElementById('conteudo-entradas').classList.add('hidden');
            document.getElementById('conteudo-saidas').classList.add('hidden');
            document.getElementById('conteudo-centros').classList.add('hidden');
            document.getElementById('conteudo-provisoes').classList.add('hidden');
            document.getElementById('conteudo-relatorios').classList.add('hidden');
            
            // Remover estilo ativo de todos os botões
            document.getElementById('tab-epis').classList.remove('border-b-2', 'border-primary', 'text-primary');
            document.getElementById('tab-entradas').classList.remove('border-b-2', 'border-primary', 'text-primary');
            document.getElementById('tab-saidas').classList.remove('border-b-2', 'border-primary', 'text-primary');
            document.getElementById('tab-centros').classList.remove('border-b-2', 'border-primary', 'text-primary');
            document.getElementById('tab-provisoes').classList.remove('border-b-2', 'border-primary', 'text-primary');
            document.getElementById('tab-relatorios').classList.remove('border-b-2', 'border-primary', 'text-primary');
            
            document.getElementById('tab-epis').classList.add('text-gray-500');
            document.getElementById('tab-entradas').classList.add('text-gray-500');
            document.getElementById('tab-saidas').classList.add('text-gray-500');
            document.getElementById('tab-centros').classList.add('text-gray-500');
            document.getElementById('tab-provisoes').classList.add('text-gray-500');
            document.getElementById('tab-relatorios').classList.add('text-gray-500');
            
            // Mostrar a aba selecionada
            document.getElementById(`conteudo-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.remove('text-gray-500');
            document.getElementById(`tab-${tab}`).classList.add('border-b-2', 'border-primary', 'text-primary');
            
            // Carregar dados da aba
            if (tab === 'epis') {
                carregarTabelaEPIs();
            } else if (tab === 'entradas') {
                carregarTabelaEntradas();
                carregarSelectEPIs('filtro-entrada-epi');
                carregarSelectEPIs('entrada-epi');
            } else if (tab === 'saidas') {
                carregarTabelaSaidas();
                carregarSelectEPIs('filtro-saida-epi');
                carregarSelectEPIs('saida-epi');
                carregarSelectCentros('filtro-saida-centro');
                carregarSelectCentros('saida-centro-custo');
            } else if (tab === 'centros') {
                carregarTabelaCentros();
            } else if (tab === 'provisoes') {
                carregarTabelaProvisoes();
                carregarSelectCentros('filtro-provisao-centro');
            } else if (tab === 'relatorios') {
                inicializarRelatorios();
            }
        }

        // Carregar tabela de EPIs
        function carregarTabelaEPIs(lista = listaEPIs) {
            const tabela = document.getElementById('tabela-epis');
            const semRegistros = document.getElementById('sem-registros-epis');
            
            // Limpa a tabela
            tabela.innerHTML = '';
            
            if (lista.length === 0) {
                tabela.parentElement.classList.add('hidden');
                semRegistros.classList.remove('hidden');
                return;
            }
            
            tabela.parentElement.classList.remove('hidden');
            semRegistros.classList.add('hidden');
            
            // Adiciona cada EPI à tabela
            lista.forEach(epi => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${epi.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${epi.codigo || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${epi.categoria}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${epi.estoque < epi.estoqueMinimo ? 'text-danger font-medium' : ''}">${epi.estoque}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${epi.estoqueMinimo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${formatarMoeda(epi.custo)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button 
                            onclick="visualizarEPI(${epi.id})" 
                            class="text-info hover:text-info/80 mr-2" 
                            title="Visualizar"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                        <button 
                            onclick="editarEPI(${epi.id})" 
                            class="text-primary hover:text-primary/80 mr-2" 
                            title="Editar"
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        <button 
                            onclick="confirmarExclusao(${epi.id}, 'epi')" 
                            class="text-danger hover:text-danger/80" 
                            title="Excluir"
                        >
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                tabela.appendChild(tr);
            });
        }

        // Carregar tabela de entradas
        function carregarTabelaEntradas(lista = listaEntradas) {
            const tabela = document.getElementById('tabela-entradas');
            const semRegistros = document.getElementById('sem-registros-entradas');
            
            // Limpa a tabela
            tabela.innerHTML = '';
            
            if (lista.length === 0) {
                tabela.parentElement.classList.add('hidden');
                semRegistros.classList.remove('hidden');
                return;
            }
            
            tabela.parentElement.classList.remove('hidden');
            semRegistros.classList.add('hidden');
            
            // Adiciona cada entrada à tabela
            lista.forEach(entrada => {
                const epi = listaEPIs.find(e => e.id === entrada.epiId) || { nome: 'EPI não encontrado' };
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${formatarData(entrada.data)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">${epi.nome}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${entrada.quantidade}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${formatarMoeda(entrada.custo)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${formatarMoeda(entrada.quantidade * entrada.custo)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${entrada.notaFiscal || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${entrada.responsavel}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <button 
                            onclick="visualizarEntrada(${entrada.id})" 
                            class="text-info hover:text-info/80 mr-2" 
                            title="Visualizar"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                        <button 
                            onclick="confirmarExclusao(${entrada.id}, 'entrada')" 
                            class="text-danger hover:text-danger/80" 
                            title="Excluir"
                        >
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                tabela.appendChild(tr);
            });
        }

        // Carregar tabela de saídas
        function carregarTabelaSaidas(lista = listaSaidas) {
            const tabela = document.getElementById('tabela-saidas');
            const semRegistros = document.getElementById('sem-registros-saidas');
            
            // Limpa a tabela
            tabela.innerHTML = '';
            
            if (lista.length === 0) {
                tabela.parentElement.classList.add('hidden');
                semRegistros.classList.remove('hidden');
                return;
            }
            
            tabela.parentElement.classList.remove('hidden');
            semRegistros.classList.add('hidden');
            
            // Adiciona cada saída à tabela
            lista.forEach(saida => {
                const epi = listaEPIs.find(e => e.id === saida.epiId) || { nome: 'EPI não encontrado', custo: 0 };
                const centro = listaCentros.find(c => c.id === saida.centroCustoId) || { nome: 'Centro de custo não encontrado' };
                
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${formatarData(saida.data)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-medium">${epi.nome}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${saida.quantidade}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${centro.nome}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${saida.destino || '-'}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${formatarMoeda(saida.quantidade * epi.custo)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">${saida.responsavel}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <button 
                            onclick="visualizarSaida(${saida.id})" 
                            class="text-info hover:text-info/80 mr-2" 
                            title="Visualizar"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                        <button 
                            onclick="confirmarExclusao(${saida.id}, 'saida')" 
                            class="text-danger hover:text-danger/80" 
                            title="Excluir"
                        >
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                tabela.appendChild(tr);
            });
        }

        // Carregar tabela de Centros de Custo
        function carregarTabelaCentros(lista = listaCentros) {
            const tabela = document.getElementById('tabela-centros');
            const semRegistros = document.getElementById('sem-registros-centros');
            
            // Limpa a tabela
            tabela.innerHTML = '';
            
            if (lista.length === 0) {
                tabela.parentElement.classList.add('hidden');
                semRegistros.classList.remove('hidden');
                return;
            }
            
            tabela.parentElement.classList.remove('hidden');
            semRegistros.classList.add('hidden');
            
            // Adiciona cada centro de custo à tabela
            lista.forEach(centro => {
                const tr = document.createElement('tr');
                
                const statusClass = centro.status === 'Ativo' ? 'text-success' : 'text-danger';
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${centro.codigo}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${centro.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${centro.responsavel}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${centro.departamento}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass} font-medium">${centro.status}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button 
                            onclick="visualizarCentro(${centro.id})" 
                            class="text-info hover:text-info/80 mr-2" 
                            title="Visualizar"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                        <button 
                            onclick="editarCentro(${centro.id})" 
                            class="text-primary hover:text-primary/80 mr-2" 
                            title="Editar"
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        <button 
                            onclick="confirmarExclusao(${centro.id}, 'centro')" 
                            class="text-danger hover:text-danger/80" 
                            title="Excluir"
                        >
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                tabela.appendChild(tr);
            });
        }
        
        // Carregar tabela de Provisionamentos
        function carregarTabelaProvisoes(lista = listaProvisoes) {
            const tabela = document.getElementById('tabela-provisoes');
            const semRegistros = document.getElementById('sem-registros-provisoes');
            
            // Limpa a tabela
            tabela.innerHTML = '';
            
            if (lista.length === 0) {
                tabela.parentElement.classList.add('hidden');
                semRegistros.classList.remove('hidden');
                return;
            }
            
            tabela.parentElement.classList.remove('hidden');
            semRegistros.classList.add('hidden');
            
            // Adiciona cada provisionamento à tabela
            lista.forEach(provisao => {
                const centro = listaCentros.find(c => c.id === provisao.centroCustoId) || { nome: 'Centro de custo não encontrado' };
                
                // Calcula valor total
                let valorTotal = 0;
                let quantidadeTotal = 0;
                
                provisao.itens.forEach(item => {
                    valorTotal += item.quantidade * item.valorUnitario;
                    quantidadeTotal += item.quantidade;
                });
                
                // Define a classe de status
                let statusClass = '';
                let statusIcon = '';
                
                if (provisao.status === 'Aprovado') {
                    statusClass = 'text-success';
                    statusIcon = 'fa-check-circle';
                } else if (provisao.status === 'Rejeitado') {
                    statusClass = 'text-danger';
                    statusIcon = 'fa-times-circle';
                } else {
                    statusClass = 'text-warning';
                    statusIcon = 'fa-clock';
                }
                
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${formatarData(provisao.dataSolicitacao)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${centro.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${provisao.mesAnoReferencia}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${quantidadeTotal} itens</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${formatarMoeda(valorTotal)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass} font-medium">
                        <i class="fas ${statusIcon} mr-1"></i>${provisao.status}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${provisao.responsavel}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button 
                            onclick="visualizarProvisao(${provisao.id})" 
                            class="text-info hover:text-info/80 mr-2" 
                            title="Visualizar"
                        >
                            <i class="fas fa-eye"></i>
                        </button>
                        <button 
                            onclick="editarProvisao(${provisao.id})" 
                            class="text-primary hover:text-primary/80 mr-2" 
                            title="Editar"
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        <button 
                            onclick="confirmarExclusao(${provisao.id}, 'provisao')" 
                            class="text-danger hover:text-danger/80" 
                            title="Excluir"
                        >
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                tabela.appendChild(tr);
            });
        }
        
        // Inicializar relatórios
        function inicializarRelatorios() {
            // Configurações iniciais para os campos de data
            const hoje = new Date();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            
            // Formatar datas para o formato YYYY-MM-DD
            document.getElementById('relatorio-periodo-inicio').value = inicioMes.toISOString().split('T')[0];
            document.getElementById('relatorio-periodo-fim').value = fimMes.toISOString().split('T')[0];
            
            // Carregar centro de custo
            carregarSelectCentros('relatorio-centro');
            
            // Ocultar o resultado do relatório
            document.getElementById('relatorio-resultado').classList.add('hidden');
            
            // Destruir gráficos anteriores se existirem
            if (graficoPorCentro) {
                graficoPorCentro.destroy();
                graficoPorCentro = null;
            }
            
            if (graficoPorCategoria) {
                graficoPorCategoria.destroy();
                graficoPorCategoria = null;
            }
        }
        
        // Gerar relatório de consumo
        function gerarRelatorioConsumo() {
            const dataInicio = document.getElementById('relatorio-periodo-inicio').value;
            const dataFim = document.getElementById('relatorio-periodo-fim').value;
            const centroId = document.getElementById('relatorio-centro').value;
            const categoria = document.getElementById('relatorio-categoria').value;
            
            // Validação básica
            if (!dataInicio || !dataFim) {
                mostrarAlertaRelatorio('Por favor, selecione um período válido para o relatório.', 'erro');
                return;
            }
            
            if (new Date(dataInicio) > new Date(dataFim)) {
                mostrarAlertaRelatorio('A data inicial não pode ser posterior à data final.', 'erro');
                return;
            }
            
            // Filtrar saídas pelo período
            let saidasFiltradas = listaSaidas.filter(saida => {
                const dataSaida = new Date(saida.data);
                return dataSaida >= new Date(dataInicio) && dataSaida <= new Date(dataFim);
            });
            
            // Filtrar por centro de custo, se selecionado
            if (centroId) {
                saidasFiltradas = saidasFiltradas.filter(saida => saida.centroCustoId == centroId);
            }
            
            // Se não houver saídas no período, mostrar mensagem
            if (saidasFiltradas.length === 0) {
                mostrarAlertaRelatorio('Não foram encontradas saídas de EPIs para o período selecionado.', 'info');
                document.getElementById('relatorio-resultado').classList.add('hidden');
                return;
            }
            
            // Preparar dados para o relatório
            const dadosProcessados = processarDadosConsumo(saidasFiltradas, categoria);
            
            // Atualizar os cabeçalhos do relatório
            atualizarCabecalhoRelatorio(dataInicio, dataFim, centroId, categoria);
            
            // Preencher tabela com os dados
            preencherTabelaRelatorioConsumo(dadosProcessados.tabelaDados);
            
            // Atualizar indicadores
            atualizarIndicadoresConsumo(dadosProcessados);
            
            // Criar ou atualizar gráficos
            criarGraficosConsumo(dadosProcessados);
            
            // Exibir o relatório
            document.getElementById('relatorio-resultado').classList.remove('hidden');
            document.getElementById('relatorio-alerta').classList.add('hidden');
        }
        
        // Mostrar alerta no relatório
        function mostrarAlertaRelatorio(mensagem, tipo) {
            const alertaEl = document.getElementById('relatorio-alerta');
            alertaEl.classList.remove('hidden', 'bg-green-50', 'bg-red-50', 'bg-yellow-50', 'bg-blue-50', 'text-green-800', 'text-red-800', 'text-yellow-800', 'text-blue-800', 'border-green-200', 'border-red-200', 'border-yellow-200', 'border-blue-200');
            
            if (tipo === 'sucesso') {
                alertaEl.classList.add('bg-green-50', 'text-green-800', 'border-green-200');
                alertaEl.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i> ${mensagem}`;
            } else if (tipo === 'erro') {
                alertaEl.classList.add('bg-red-50', 'text-red-800', 'border-red-200');
                alertaEl.innerHTML = `<i class="fas fa-exclamation-circle text-red-500 mr-2"></i> ${mensagem}`;
            } else if (tipo === 'aviso') {
                alertaEl.classList.add('bg-yellow-50', 'text-yellow-800', 'border-yellow-200');
                alertaEl.innerHTML = `<i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i> ${mensagem}`;
            } else {
                alertaEl.classList.add('bg-blue-50', 'text-blue-800', 'border-blue-200');
                alertaEl.innerHTML = `<i class="fas fa-info-circle text-blue-500 mr-2"></i> ${mensagem}`;
            }
            
            alertaEl.classList.add('p-4', 'rounded-lg', 'border');
        }
        
        // Processar dados para o relatório de consumo
        function processarDadosConsumo(saidas, categoriaFiltro) {
            // Dados por centro de custo
            const dadosPorCentro = {};
            
            // Dados por categoria
            const dadosPorCategoria = {};
            
            // Dados por EPI
            const dadosPorEPI = {};
            
            // Dados para a tabela detalhada
            const tabelaDados = [];
            
            // Total geral
            let totalQuantidade = 0;
            let totalValor = 0;
            
            // Registros para maior consumo
            let maiorConsumoValorCentro = { id: null, nome: '-', valor: 0 };
            let maiorConsumoQuantidadeEPI = { id: null, nome: '-', quantidade: 0 };
            
            // Processar cada saída
            saidas.forEach(saida => {
                const epi = listaEPIs.find(e => e.id === saida.epiId) || { nome: 'EPI não encontrado', custo: 0, categoria: 'Não categorizado' };
                const centro = listaCentros.find(c => c.id === saida.centroCustoId) || { nome: 'Centro não encontrado' };
                
                // Se tiver filtro de categoria, pular EPIs de outras categorias
                if (categoriaFiltro && epi.categoria !== categoriaFiltro) {
                    return;
                }
                
                const valorSaida = saida.quantidade * epi.custo;
                
                // Acumular por centro de custo
                if (!dadosPorCentro[centro.id]) {
                    dadosPorCentro[centro.id] = {
                        nome: centro.nome,
                        quantidade: 0,
                        valor: 0
                    };
                }
                dadosPorCentro[centro.id].quantidade += saida.quantidade;
                dadosPorCentro[centro.id].valor += valorSaida;
                
                // Verificar maior consumo por centro
                if (dadosPorCentro[centro.id].valor > maiorConsumoValorCentro.valor) {
                    maiorConsumoValorCentro = {
                        id: centro.id,
                        nome: centro.nome,
                        valor: dadosPorCentro[centro.id].valor
                    };
                }
                
                // Acumular por categoria
                if (!dadosPorCategoria[epi.categoria]) {
                    dadosPorCategoria[epi.categoria] = {
                        nome: epi.categoria,
                        quantidade: 0,
                        valor: 0
                    };
                }
                dadosPorCategoria[epi.categoria].quantidade += saida.quantidade;
                dadosPorCategoria[epi.categoria].valor += valorSaida;
                
                // Acumular por EPI
                const epiKey = `${epi.id}-${centro.id}`;
                if (!dadosPorEPI[epiKey]) {
                    dadosPorEPI[epiKey] = {
                        epiId: epi.id,
                        epiNome: epi.nome,
                        epiCategoria: epi.categoria,
                        centroId: centro.id,
                        centroNome: centro.nome,
                        quantidade: 0,
                        valorUnitario: epi.custo,
                        valorTotal: 0
                    };
                }
                dadosPorEPI[epiKey].quantidade += saida.quantidade;
                dadosPorEPI[epiKey].valorTotal += valorSaida;
                
                // Verificar EPI mais consumido em quantidade
                if (!dadosPorEPI[epi.id]) {
                    dadosPorEPI[epi.id] = { 
                        id: epi.id,
                        nome: epi.nome,
                        quantidade: 0 
                    };
                }
                dadosPorEPI[epi.id].quantidade += saida.quantidade;
                
                if (dadosPorEPI[epi.id].quantidade > maiorConsumoQuantidadeEPI.quantidade) {
                    maiorConsumoQuantidadeEPI = {
                        id: epi.id,
                        nome: epi.nome,
                        quantidade: dadosPorEPI[epi.id].quantidade
                    };
                }
                
                // Acumular totais
                totalQuantidade += saida.quantidade;
                totalValor += valorSaida;
                
                // Adicionar à tabela de dados
                const linhaDados = {
                    centroNome: centro.nome,
                    epiNome: epi.nome,
                    epiCategoria: epi.categoria,
                    quantidade: saida.quantidade,
                    valorUnitario: epi.custo,
                    valorTotal: valorSaida
                };
                
                // Verificar se já existe um registro igual
                const indiceExistente = tabelaDados.findIndex(item => 
                    item.centroNome === linhaDados.centroNome && 
                    item.epiNome === linhaDados.epiNome
                );
                
                if (indiceExistente >= 0) {
                    // Se existir, soma os valores
                    tabelaDados[indiceExistente].quantidade += linhaDados.quantidade;
                    tabelaDados[indiceExistente].valorTotal += linhaDados.valorTotal;
                } else {
                    // Se não existir, adiciona novo registro
                    tabelaDados.push(linhaDados);
                }
            });
            
            // Calcular percentual do total para cada item da tabela
            tabelaDados.forEach(item => {
                item.percentual = (item.valorTotal / totalValor) * 100;
            });
            
            // Ordenar a tabela por valor total (decrescente)
            tabelaDados.sort((a, b) => b.valorTotal - a.valorTotal);
            
            return {
                dadosPorCentro,
                dadosPorCategoria,
                dadosPorEPI,
                tabelaDados,
                totalQuantidade,
                totalValor,
                maiorConsumoValorCentro,
                maiorConsumoQuantidadeEPI
            };
        }
        
        // Atualizar o cabeçalho do relatório
        function atualizarCabecalhoRelatorio(dataInicio, dataFim, centroId, categoria) {
            let titulo = "Consumo de EPIs por Centro de Custo";
            
            if (centroId) {
                const centro = listaCentros.find(c => c.id == centroId);
                if (centro) {
                    titulo += ` - ${centro.nome}`;
                }
            }
            
            if (categoria) {
                titulo += ` - Categoria: ${categoria}`;
            }
            
            titulo += ` (${formatarData(dataInicio)} a ${formatarData(dataFim)})`;
            
            document.getElementById('relatorio-titulo').textContent = titulo;
        }
        
        // Preencher tabela do relatório de consumo
        function preencherTabelaRelatorioConsumo(dados) {
            const tabela = document.getElementById('tabela-relatorio-consumo');
            const totalQuantidade = document.getElementById('total-quantidade');
            const totalValor = document.getElementById('total-valor');
            
            // Limpa a tabela
            tabela.innerHTML = '';
            
            // Totais
            let quantidadeTotal = 0;
            let valorTotal = 0;
            
            // Adiciona cada linha à tabela
            dados.forEach(item => {
                const tr = document.createElement('tr');
                
                quantidadeTotal += item.quantidade;
                valorTotal += item.valorTotal;
                
                tr.innerHTML = `
                    <td class="px-6 py-3 text-sm">${item.centroNome}</td>
                    <td class="px-6 py-3 text-sm font-medium">${item.epiNome}</td>
                    <td class="px-6 py-3 text-sm">${item.epiCategoria}</td>
                    <td class="px-6 py-3 text-sm">${item.quantidade}</td>
                    <td class="px-6 py-3 text-sm">${formatarMoeda(item.valorUnitario)}</td>
                    <td class="px-6 py-3 text-sm font-medium">${formatarMoeda(item.valorTotal)}</td>
                    <td class="px-6 py-3 text-sm">${item.percentual.toFixed(2)}%</td>
                `;
                
                tabela.appendChild(tr);
            });
            
            // Atualizar totais no rodapé
            totalQuantidade.textContent = quantidadeTotal;
            totalValor.textContent = formatarMoeda(valorTotal);
        }
        
        // Atualizar indicadores do relatório
        function atualizarIndicadoresConsumo(dados) {
            document.getElementById('indicador-total-itens').textContent = dados.totalQuantidade;
            document.getElementById('indicador-valor-total').textContent = formatarMoeda(dados.totalValor);
            document.getElementById('indicador-maior-centro').textContent = dados.maiorConsumoValorCentro.nome;
            document.getElementById('indicador-maior-epi').textContent = dados.maiorConsumoQuantidadeEPI.nome;
        }
        
        // Criar gráficos do relatório de consumo
        function criarGraficosConsumo(dados) {
            // Destruir gráficos anteriores, se existirem
            if (graficoPorCentro) {
                graficoPorCentro.destroy();
            }
            
            if (graficoPorCategoria) {
                graficoPorCategoria.destroy();
            }
            
            // Preparar dados para o gráfico por centro de custo
            const dadosCentro = {
                labels: Object.values(dados.dadosPorCentro).map(c => c.nome),
                datasets: [{
                    label: 'Valor Consumido (R$)',
                    data: Object.values(dados.dadosPorCentro).map(c => c.valor),
                    backgroundColor: [
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ],
                    borderColor: [
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            };
            
            // Preparar dados para o gráfico por categoria
            const dadosCategoria = {
                labels: Object.values(dados.dadosPorCategoria).map(c => c.nome),
                datasets: [{
                    label: 'Valor Consumido (R$)',
                    data: Object.values(dados.dadosPorCategoria).map(c => c.valor),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.7)',
                        'rgba(54, 162, 235, 0.7)',
                        'rgba(255, 206, 86, 0.7)',
                        'rgba(75, 192, 192, 0.7)',
                        'rgba(153, 102, 255, 0.7)',
                        'rgba(255, 159, 64, 0.7)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            };
            
            // Configurações comuns
            const opcoes = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 15,
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += formatarMoeda(context.raw);
                                return label;
                            }
                        }
                    }
                }
            };
            
            // Criar gráfico por centro
            const ctxCentro = document.getElementById('grafico-consumo-centro').getContext('2d');
            graficoPorCentro = new Chart(ctxCentro, {
                type: 'pie',
                data: dadosCentro,
                options: opcoes
            });
            
            // Criar gráfico por categoria
            const ctxCategoria = document.getElementById('grafico-consumo-categoria').getContext('2d');
            graficoPorCategoria = new Chart(ctxCategoria, {
                type: 'doughnut',
                data: dadosCategoria,
                options: opcoes
            });
        }
        
        // Exportar relatório para PDF
        function exportarRelatorioPDF() {
            mostrarToast('Exportação para PDF iniciada. O download começará em breve...', 'info');
            // Aqui seria implementada a lógica real de exportação para PDF
            setTimeout(() => {
                mostrarToast('Relatório exportado com sucesso para PDF!', 'sucesso');
            }, 1500);
        }
        
        // Exportar relatório para Excel
        function exportarRelatorioExcel() {
            mostrarToast('Exportação para Excel iniciada. O download começará em breve...', 'info');
            // Aqui seria implementada a lógica real de exportação para Excel
            setTimeout(() => {
                mostrarToast('Relatório exportado com sucesso para Excel!', 'sucesso');
            }, 1500);
        }

        // Carregar select de EPIs
        function carregarSelectEPIs(elementId) {
            const select = document.getElementById(elementId);
            
            // Mantém a primeira opção e remove as demais
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Adiciona os EPIs ao select
            listaEPIs.forEach(epi => {
                const option = document.createElement('option');
                option.value = epi.id;
                option.textContent = epi.nome;
                select.appendChild(option);
            });
        }

        // Carregar select de Centros de Custo
        function carregarSelectCentros(elementId) {
            const select = document.getElementById(elementId);
            
            // Mantém a primeira opção e remove as demais
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Filtra apenas centros ativos para formulários
            let listaCentrosAtivos = listaCentros;
            if (elementId !== 'filtro-provisao-centro' && elementId !== 'filtro-saida-centro' && elementId !== 'relatorio-centro') {
                listaCentrosAtivos = listaCentros.filter(centro => centro.status === 'Ativo');
            }
            
            // Adiciona os centros ao select
            listaCentrosAtivos.forEach(centro => {
                const option = document.createElement('option');
                option.value = centro.id;
                option.textContent = centro.nome;
                select.appendChild(option);
            });
        }

        // Atualizar informações do EPI no formulário de entrada/saída
        function atualizarInfoEPI(id, tipo) {
            if (!id) {
                document.getElementById(`${tipo}-estoque-info`).textContent = 'Estoque atual: -';
                if (tipo === 'entrada') {
                    document.getElementById('entrada-custo-info').textContent = 'Custo atual: -';
                }
                return;
            }
            
            const epi = listaEPIs.find(e => e.id == id);
            if (!epi) return;
            
            if (tipo === 'entrada') {
                document.getElementById('entrada-estoque-info').textContent = `Estoque atual: ${epi.estoque} ${epi.unidade.toLowerCase()}`;
                document.getElementById('entrada-custo-info').textContent = `Custo atual: ${formatarMoeda(epi.custo)}`;
                document.getElementById('entrada-custo').value = epi.custo;
                document.getElementById('entrada-fornecedor').value = epi.fornecedor || '';
            } else {
                document.getElementById('saida-estoque-info').textContent = `Estoque disponível: ${epi.estoque} ${epi.unidade.toLowerCase()}`;
            }
        }
        
        // Atualizar valor do item de provisionamento
        function atualizarValorItem() {
            const epiId = document.getElementById('item-epi').value;
            const quantidade = parseInt(document.getElementById('item-quantidade').value) || 0;
            
            if (!epiId) {
                document.getElementById('item-valor').value = '';
                return;
            }
            
            const epi = listaEPIs.find(e => e.id == epiId);
            if (!epi) return;
            
            document.getElementById('item-valor').value = epi.custo;
        }
        
        // Adicionar item ao provisionamento
        function adicionarItemProvisao() {
            carregarSelectEPIs('item-epi');
            document.getElementById('form-item-provisao').reset();
            document.getElementById('item-quantidade').value = 1;
            
            // Configurar o handler do formulário
            document.getElementById('form-item-provisao').onsubmit = function(e) {
                e.preventDefault();
                
                const epiId = parseInt(document.getElementById('item-epi').value);
                const quantidade = parseInt(document.getElementById('item-quantidade').value);
                
                if (!epiId || !quantidade || quantidade <= 0) {
                    mostrarToast('Preencha todos os campos corretamente.', 'erro');
                    return;
                }
                
                const epi = listaEPIs.find(e => e.id === epiId);
                if (!epi) {
                    mostrarToast('EPI não encontrado.', 'erro');
                    return;
                }
                
                // Verificar se o EPI já está na lista
                const itemExistente = itensProvisao.find(item => item.epiId === epiId);
                if (itemExistente) {
                    mostrarToast('Este EPI já está na lista de itens. Edite a quantidade existente.', 'aviso');
                    return;
                }
                
                // Adicionar o item à lista
                const novoItem = {
                    id: itensProvisao.length > 0 ? Math.max(...itensProvisao.map(i => i.id)) + 1 : 1,
                    epiId,
                    quantidade,
                    valorUnitario: epi.custo
                };
                
                itensProvisao.push(novoItem);
                
                // Atualizar a tabela de itens
                atualizarTabelaItensProvisao();
                
                // Fechar o modal
                fecharModal('modal-adicionar-item');
                
                // Mostrar feedback
                mostrarToast('Item adicionado com sucesso!', 'sucesso');
            };
            
            abrirModal('modal-adicionar-item');
        }
        
        // Excluir item do provisionamento
        function excluirItemProvisao(id) {
            itensProvisao = itensProvisao.filter(item => item.id !== id);
            atualizarTabelaItensProvisao();
            mostrarToast('Item removido com sucesso!', 'sucesso');
        }
        
        // Atualizar tabela de itens do provisionamento
        function atualizarTabelaItensProvisao() {
            const tabela = document.getElementById('tabela-itens-provisao');
            const semItens = document.getElementById('sem-itens-provisao');
            
            // Limpa a tabela
            tabela.innerHTML = '';
            
            if (itensProvisao.length === 0) {
                tabela.parentElement.parentElement.classList.add('hidden');
                semItens.classList.remove('hidden');
                document.getElementById('provisao-valor-total').textContent = formatarMoeda(0);
                return;
            }
            
            tabela.parentElement.parentElement.classList.remove('hidden');
            semItens.classList.add('hidden');
            
            // Calcula o valor total
            let valorTotal = 0;
            
            // Adiciona cada item à tabela
            itensProvisao.forEach(item => {
                const epi = listaEPIs.find(e => e.id === item.epiId) || { nome: 'EPI não encontrado' };
                const valorItem = item.quantidade * item.valorUnitario;
                valorTotal += valorItem;
                
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td class="px-4 py-2 text-sm">${epi.nome}</td>
                    <td class="px-4 py-2 text-sm">${item.quantidade} ${epi.unidade ? epi.unidade.toLowerCase() : ''}</td>
                    <td class="px-4 py-2 text-sm">${formatarMoeda(item.valorUnitario)}</td>
                    <td class="px-4 py-2 text-sm">${formatarMoeda(valorItem)}</td>
                    <td class="px-4 py-2 text-sm">
                        <button 
                            type="button"
                            onclick="excluirItemProvisao(${item.id})" 
                            class="text-danger hover:text-danger/80" 
                            title="Remover Item"
                        >
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                tabela.appendChild(tr);
            });
            
            // Atualiza o valor total
            document.getElementById('provisao-valor-total').textContent = formatarMoeda(valorTotal);
        }

        // Buscar EPIs
        function buscarEPIs() {
            const textoBusca = document.getElementById('busca-epi').value.toLowerCase();
            
            if (!textoBusca) {
                carregarTabelaEPIs();
                return;
            }
            
            const resultado = listaEPIs.filter(epi => 
                epi.nome.toLowerCase().includes(textoBusca) || 
                (epi.codigo && epi.codigo.toLowerCase().includes(textoBusca))
            );
            
            carregarTabelaEPIs(resultado);
            
            if (resultado.length === 0) {
                mostrarToast('Nenhum EPI encontrado com o termo buscado.', 'info');
            }
        }

        // Buscar Centros de Custo
        function buscarCentros() {
            const textoBusca = document.getElementById('busca-centro').value.toLowerCase();
            
            if (!textoBusca) {
                carregarTabelaCentros();
                return;
            }
            
            const resultado = listaCentros.filter(centro => 
                centro.nome.toLowerCase().includes(textoBusca) || 
                centro.codigo.toLowerCase().includes(textoBusca)
            );
            
            carregarTabelaCentros(resultado);
            
            if (resultado.length === 0) {
                mostrarToast('Nenhum centro de custo encontrado com o termo buscado.', 'info');
            }
        }

        // Filtrar entradas
        function filtrarEntradas() {
            const epiId = document.getElementById('filtro-entrada-epi').value;
            
            if (!epiId) {
                carregarTabelaEntradas();
                return;
            }
            
            const resultado = listaEntradas.filter(entrada => entrada.epiId == epiId);
            
            carregarTabelaEntradas(resultado);
            
            if (resultado.length === 0) {
                mostrarToast('Nenhuma entrada encontrada para este EPI.', 'info');
            }
        }

        // Filtrar saídas
        function filtrarSaidas() {
            const epiId = document.getElementById('filtro-saida-epi').value;
            const centroId = document.getElementById('filtro-saida-centro').value;
            
            // Começar com a lista completa de saídas
            let resultado = [...listaSaidas];
            
            // Filtrar por EPI apenas se um EPI específico foi selecionado
            if (epiId !== "") {
                // Converter explicitamente para número para garantir comparação correta
                const epiIdNumero = parseInt(epiId);
                resultado = resultado.filter(saida => saida.epiId === epiIdNumero);
            }
            
            // Filtrar por Centro de Custo apenas se um centro específico foi selecionado
            if (centroId !== "") {
                // Converter explicitamente para número para garantir comparação correta
                const centroIdNumero = parseInt(centroId);
                resultado = resultado.filter(saida => saida.centroCustoId === centroIdNumero);
            }
            
            // Atualizar a tabela com os resultados filtrados
            carregarTabelaSaidas(resultado);
            
            // Exibir mensagem se nenhum resultado for encontrado
            if (resultado.length === 0) {
                mostrarToast('Nenhuma saída encontrada com os filtros selecionados.', 'info');
            }
        }
        
        // Filtrar provisões
        function filtrarProvisoes() {
            const centroId = document.getElementById('filtro-provisao-centro').value;
            const status = document.getElementById('filtro-provisao-status').value;
            const mesAno = document.getElementById('filtro-provisao-mes').value;
            
            let resultado = listaProvisoes;
            
            if (centroId) {
                resultado = resultado.filter(provisao => provisao.centroCustoId == centroId);
            }
            
            if (status) {
                resultado = resultado.filter(provisao => provisao.status === status);
            }
            
            if (mesAno) {
                resultado = resultado.filter(provisao => provisao.mesAnoReferencia === mesAno);
            }
            
            carregarTabelaProvisoes(resultado);
            
            if (resultado.length === 0) {
                mostrarToast('Nenhum provisionamento encontrado com os filtros selecionados.', 'info');
            }
        }

        // Abrir modal de cadastro de EPI
        function abrirModalCadastro() {
            document.getElementById('modal-titulo').textContent = 'Cadastrar Novo EPI';
            document.getElementById('form-epi').reset();
            document.getElementById('epi-id').value = '';
            
            // Define a data de validade para 1 ano à frente como sugestão
            const hoje = new Date();
            const umAnoDepois = new Date(hoje.setFullYear(hoje.getFullYear() + 1)).toISOString().split('T')[0];
            document.getElementById('epi-validade').value = umAnoDepois;
            
            abrirModal('modal-epi');
        }

        // Abrir modal de cadastro de Centro de Custo
        function abrirModalCentro() {
            document.getElementById('modal-titulo-centro').textContent = 'Cadastrar Novo Centro de Custo';
            document.getElementById('form-centro').reset();
            document.getElementById('centro-id').value = '';
            document.getElementById('centro-status').value = 'Ativo';
            
            abrirModal('modal-centro');
        }
        
        // Abrir modal de cadastro de Provisionamento
        function abrirModalProvisao() {
            document.getElementById('modal-titulo-provisao').textContent = 'Cadastrar Novo Provisionamento';
            document.getElementById('form-provisao').reset();
            document.getElementById('provisao-id').value = '';
            document.getElementById('provisao-status').value = 'Solicitado';
            
            // Limpar a lista de itens
            itensProvisao = [];
            atualizarTabelaItensProvisao();
            
            // Carregar select de centros de custo
            carregarSelectCentros('provisao-centro');
            
            // Define a data atual
            const hoje = new Date();
            const mesAtual = hoje.getMonth() + 1;
            const anoAtual = hoje.getFullYear();
            const proximoMes = mesAtual === 12 ? '01/' + (anoAtual + 1) : ('0' + (mesAtual + 1)).slice(-2) + '/' + anoAtual;
            
            document.getElementById('provisao-mes-ano').value = proximoMes;
            
            abrirModal('modal-provisao');
        }

        // Fechar modal de cadastro
        function fecharModalCadastro() {
            fecharModal('modal-epi');
        }

        // Abrir modal de entrada
        function abrirModalEntrada() {
            document.getElementById('form-entrada').reset();
            
            // Define a data para hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('entrada-data').value = hoje;
            
            abrirModal('modal-entrada');
        }

        // Abrir modal de saída
        function abrirModalSaida() {
            document.getElementById('form-saida').reset();
            
            // Define a data para hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('saida-data').value = hoje;
            
            abrirModal('modal-saida');
        }

        // Visualizar EPI
        function visualizarEPI(id) {
            epiAtual = listaEPIs.find(epi => epi.id === id);
            
            if (!epiAtual) return;
            
            document.getElementById('visualizacao-titulo').textContent = `Detalhes do EPI: ${epiAtual.nome}`;
            document.getElementById('visualizacao-nome').textContent = epiAtual.nome;
            document.getElementById('visualizacao-codigo').textContent = epiAtual.codigo || '-';
            document.getElementById('visualizacao-categoria').textContent = epiAtual.categoria;
            document.getElementById('visualizacao-unidade').textContent = epiAtual.unidade;
            document.getElementById('visualizacao-estoque').textContent = epiAtual.estoque;
            document.getElementById('visualizacao-estoque-minimo').textContent = epiAtual.estoqueMinimo;
            document.getElementById('visualizacao-custo').textContent = formatarMoeda(epiAtual.custo);
            document.getElementById('visualizacao-ca').textContent = epiAtual.ca;
            document.getElementById('visualizacao-fornecedor').textContent = epiAtual.fornecedor;
            document.getElementById('visualizacao-validade').textContent = epiAtual.validade ? formatarData(epiAtual.validade) : '-';
            document.getElementById('visualizacao-localizacao').textContent = epiAtual.localizacao || '-';
            document.getElementById('visualizacao-descricao').textContent = epiAtual.descricao;
            
            // Status do estoque
            const statusEl = document.getElementById('visualizacao-status');
            if (epiAtual.estoque < epiAtual.estoqueMinimo) {
                statusEl.textContent = 'Abaixo do Mínimo';
                statusEl.className = 'font-medium text-danger';
            } else if (epiAtual.estoque <= epiAtual.estoqueMinimo * 1.2) {
                statusEl.textContent = 'Próximo ao Mínimo';
                statusEl.className = 'font-medium text-warning';
            } else {
                statusEl.textContent = 'Adequado';
                statusEl.className = 'font-medium text-success';
            }
            
            // Configurar botão de editar
            document.getElementById('btn-editar').onclick = function() {
                fecharModal('modal-visualizacao');
                editarEPI(epiAtual.id);
            };
            
            abrirModal('modal-visualizacao');
        }

        // Variável global para armazenar ID do centro atual sendo visualizado
        let centroVisualizado = null;
        
        // Função para verificar a existência de um modal e criar um temporário se necessário
        function verificarModal(id, titulo) {
            const modal = document.getElementById(id);
            if (modal) {
                return true;
            }
            
            // Modal não encontrado - Criar um modal temporário se for o caso de visualização
            if (id === 'detalhes-movimentacao') {
                console.warn(`Modal ${id} não encontrado. Criando um temporário...`);
                
                // Criar o modal temporário
                const tempModal = document.createElement('div');
                tempModal.id = id;
                tempModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50';
                tempModal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl mx-4">
                        <div class="flex justify-between items-center p-4 border-b">
                            <h2 id="detalhes-movimentacao-titulo" class="text-xl font-bold text-gray-800">${titulo || 'Detalhes'}</h2>
                            <button onclick="fecharModal('${id}')" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div id="detalhes-movimentacao-conteudo" class="p-4">
                            <!-- O conteúdo será preenchido via JavaScript -->
                        </div>
                        <div class="p-4 border-t flex justify-end">
                            <button 
                                type="button" 
                                onclick="fecharModal('${id}')" 
                                class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50"
                            >
                                Fechar
                            </button>
                        </div>
                    </div>
                `;
                
                // Adicionar ao body
                document.body.appendChild(tempModal);
                return true;
            }
            
            // Modal não encontrado e não é um caso especial
            return false;
        }
        
        // Visualizar Centro de Custo - versão robusta com verificação de existência dos modais
        function visualizarCentro(id) {
            // Guarda o ID na variável global
            centroVisualizado = id;
            
            // Busca dados do centro
            const centro = listaCentros.find(c => c.id === id);
            if (!centro) {
                mostrarToast('Centro de custo não encontrado.', 'erro');
                return;
            }
            
            // Verificar se o modal existe
            const titulo = `Detalhes do Centro de Custo: ${centro.nome}`;
            if (!verificarModal('detalhes-movimentacao', titulo)) {
                mostrarToast('Erro ao abrir detalhes. Modal não encontrado.', 'erro');
                return;
            }
            
            // Agora sabemos que o modal existe (original ou temporário)
            
            // Definir título do modal
            const tituloEl = document.getElementById('detalhes-movimentacao-titulo');
            if (tituloEl) {
                tituloEl.textContent = titulo;
            }
            
            // Define a classe de status
            const statusClass = centro.status === 'Ativo' ? 'text-success' : 'text-danger';
            
            // Preenche o conteúdo
            const conteudoEl = document.getElementById('detalhes-movimentacao-conteudo');
            if (conteudoEl) {
                conteudoEl.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="text-sm text-gray-500">Código:</p>
                            <p class="font-medium">${centro.codigo}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Contrato:</p>
                            <p class="font-medium">${centro.nome}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Responsável:</p>
                            <p class="font-medium">${centro.responsavel}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Setor:</p>
                            <p class="font-medium">${centro.departamento}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Status:</p>
                            <p class="font-medium ${statusClass}">${centro.status}</p>
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Observações:</p>
                        <p class="mt-1">${centro.observacoes || 'Nenhuma observação.'}</p>
                    </div>
                    <div class="mt-6 pt-4 border-t">
                        <button 
                            type="button" 
                            onclick="prepararEdicaoCentro()"
                            class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90"
                        >
                            <i class="fas fa-edit mr-2"></i> Editar
                        </button>
                    </div>
                `;
            }
            
            // Mostra o modal
            abrirModal('detalhes-movimentacao');
        }
        
        // Função de preparação para edição - agora independente da estrutura do DOM
        function prepararEdicaoCentro() {
            if (!centroVisualizado) {
                mostrarToast('Não foi possível identificar o centro de custo.', 'erro');
                return;
            }
            
            // Fechar o modal de detalhes antes de prosseguir
            fecharModal('detalhes-movimentacao');
            
            // Chamar função de edição com o ID armazenado
            editarCentro(centroVisualizado);
        }
        
        // Função simplificada para editar o centro de custo
        function editarCentro(id) {
            // Buscar centro pelo ID
            const centro = listaCentros.find(c => c.id === id);
            if (!centro) {
                mostrarToast('Centro de custo não encontrado.', 'erro');
                return;
            }
            
            // Armazenar o centro atual na variável global
            centroAtual = centro;
            
            // Preparar o título
            const tituloEl = document.getElementById('modal-titulo-centro');
            if (tituloEl) {
                tituloEl.textContent = `Editar Centro de Custo: ${centro.nome}`;
            }
            
            // Preencher o formulário com segurança
            const setValueSafely = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.value = value;
            };
            
            setValueSafely('centro-id', centro.id);
            setValueSafely('centro-codigo', centro.codigo);
            setValueSafely('centro-nome', centro.nome);
            setValueSafely('centro-responsavel', centro.responsavel);
            setValueSafely('centro-departamento', centro.departamento);
            setValueSafely('centro-status', centro.status);
            setValueSafely('centro-observacoes', centro.observacoes || '');
            
            // Abrir o modal de edição
            abrirModal('modal-centro');
        }
        
        // Visualizar Provisionamento
        function visualizarProvisao(id) {
            provisaoAtual = listaProvisoes.find(provisao => provisao.id === id);
            
            if (!provisaoAtual) return;
            
            const centro = listaCentros.find(c => c.id === provisaoAtual.centroCustoId) || { nome: 'Centro de custo não encontrado' };
            
            document.getElementById('detalhes-provisao-titulo').textContent = `Detalhes do Provisionamento: ${centro.nome}`;
            document.getElementById('detalhes-provisao-centro').textContent = centro.nome;
            document.getElementById('detalhes-provisao-data').textContent = formatarData(provisaoAtual.dataSolicitacao);
            document.getElementById('detalhes-provisao-mes-ano').textContent = provisaoAtual.mesAnoReferencia;
            document.getElementById('detalhes-provisao-responsavel').textContent = provisaoAtual.responsavel;
            
            // Status
            const statusEl = document.getElementById('detalhes-provisao-status');
            let statusClass = '';
            
            if (provisaoAtual.status === 'Aprovado') {
                statusClass = 'text-success';
            } else if (provisaoAtual.status === 'Rejeitado') {
                statusClass = 'text-danger';
            } else {
                statusClass = 'text-warning';
            }
            
            statusEl.textContent = provisaoAtual.status;
            statusEl.className = `font-medium ${statusClass}`;
            
            // Justificativa e Observações
            document.getElementById('detalhes-provisao-justificativa').textContent = provisaoAtual.justificativa;
            document.getElementById('detalhes-provisao-observacoes').textContent = provisaoAtual.observacoes || 'Nenhuma observação.';
            
            // Itens
            const tabelaItens = document.getElementById('detalhes-provisao-itens');
            tabelaItens.innerHTML = '';
            
            let valorTotal = 0;
            
            provisaoAtual.itens.forEach(item => {
                const epi = listaEPIs.find(e => e.id === item.epiId) || { nome: 'EPI não encontrado' };
                const valorItem = item.quantidade * item.valorUnitario;
                valorTotal += valorItem;
                
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td class="px-4 py-2 text-sm">${epi.nome}</td>
                    <td class="px-4 py-2 text-sm">${item.quantidade} ${epi.unidade ? epi.unidade.toLowerCase() : ''}</td>
                    <td class="px-4 py-2 text-sm">${formatarMoeda(item.valorUnitario)}</td>
                    <td class="px-4 py-2 text-sm">${formatarMoeda(valorItem)}</td>
                `;
                
                tabelaItens.appendChild(tr);
            });
            
            document.getElementById('detalhes-provisao-total').textContent = formatarMoeda(valorTotal);
            document.getElementById('detalhes-provisao-valor').textContent = formatarMoeda(valorTotal);
            
            // Configurar botões de ação
            document.getElementById('btn-editar-provisao').onclick = function() {
                fecharModal('detalhes-provisao');
                editarProvisao(provisaoAtual.id);
            };
            
            document.getElementById('btn-aprovar-provisao').onclick = function() {
                atualizarStatusProvisao(provisaoAtual.id, 'Aprovado');
            };
            
            document.getElementById('btn-rejeitar-provisao').onclick = function() {
                atualizarStatusProvisao(provisaoAtual.id, 'Rejeitado');
            };
            
            // Mostrar/esconder botões de aprovação/rejeição de acordo com o status atual
            if (provisaoAtual.status === 'Solicitado') {
                document.getElementById('btn-aprovar-provisao').style.display = 'inline-flex';
                document.getElementById('btn-rejeitar-provisao').style.display = 'inline-flex';
            } else {
                document.getElementById('btn-aprovar-provisao').style.display = 'none';
                document.getElementById('btn-rejeitar-provisao').style.display = 'none';
            }
            
            abrirModal('detalhes-provisao');
        }

        // Editar EPI
        function editarEPI(id) {
            epiAtual = listaEPIs.find(epi => epi.id === id);
            
            if (!epiAtual) return;
            
            document.getElementById('modal-titulo').textContent = `Editar EPI: ${epiAtual.nome}`;
            document.getElementById('epi-id').value = epiAtual.id;
            document.getElementById('epi-nome').value = epiAtual.nome;
            document.getElementById('epi-codigo').value = epiAtual.codigo || '';
            document.getElementById('epi-categoria').value = epiAtual.categoria;
            document.getElementById('epi-unidade').value = epiAtual.unidade;
            document.getElementById('epi-estoque').value = epiAtual.estoque;
            document.getElementById('epi-estoque-minimo').value = epiAtual.estoqueMinimo;
            document.getElementById('epi-custo').value = epiAtual.custo;
            document.getElementById('epi-ca').value = epiAtual.ca;
            document.getElementById('epi-fornecedor').value = epiAtual.fornecedor;
            document.getElementById('epi-validade').value = epiAtual.validade || '';
            document.getElementById('epi-localizacao').value = epiAtual.localizacao || '';
            document.getElementById('epi-descricao').value = epiAtual.descricao;
            
            abrirModal('modal-epi');
        }

        // Editar Centro de Custo
        function editarCentro(id) {
            centroAtual = listaCentros.find(centro => centro.id === id);
            
            if (!centroAtual) return;
            
            document.getElementById('modal-titulo-centro').textContent = `Editar Centro de Custo: ${centroAtual.nome}`;
            document.getElementById('centro-id').value = centroAtual.id;
            document.getElementById('centro-codigo').value = centroAtual.codigo;
            document.getElementById('centro-nome').value = centroAtual.nome;
            document.getElementById('centro-responsavel').value = centroAtual.responsavel;
            document.getElementById('centro-departamento').value = centroAtual.departamento;
            document.getElementById('centro-status').value = centroAtual.status;
            document.getElementById('centro-observacoes').value = centroAtual.observacoes || '';
            
            fecharModal('detalhes-movimentacao');
            abrirModal('modal-centro');
        }
        
        // Editar Provisionamento
        function editarProvisao(id) {
            provisaoAtual = listaProvisoes.find(provisao => provisao.id === id);
            
            if (!provisaoAtual) return;
            
            document.getElementById('modal-titulo-provisao').textContent = `Editar Provisionamento`;
            document.getElementById('provisao-id').value = provisaoAtual.id;
            document.getElementById('provisao-centro').value = provisaoAtual.centroCustoId;
            document.getElementById('provisao-mes-ano').value = provisaoAtual.mesAnoReferencia;
            document.getElementById('provisao-responsavel').value = provisaoAtual.responsavel;
            document.getElementById('provisao-status').value = provisaoAtual.status;
            document.getElementById('provisao-justificativa').value = provisaoAtual.justificativa;
            document.getElementById('provisao-observacoes').value = provisaoAtual.observacoes || '';
            
            // Copiar os itens
            itensProvisao = [...provisaoAtual.itens];
            atualizarTabelaItensProvisao();
            
            abrirModal('modal-provisao');
        }
        
        // Atualizar status de provisionamento
        function atualizarStatusProvisao(id, novoStatus) {
            const provisao = listaProvisoes.find(p => p.id === id);
            if (!provisao) return;
            
            provisao.status = novoStatus;
            
            fecharModal('detalhes-provisao');
            mostrarToast(`Provisionamento ${novoStatus.toLowerCase()} com sucesso!`, 'sucesso');
            
            carregarTabelaProvisoes();
        }

        // Visualizar entrada
        function visualizarEntrada(id) {
            entradaAtual = listaEntradas.find(entrada => entrada.id === id);
            
            if (!entradaAtual) return;
            
            const epi = listaEPIs.find(e => e.id === entradaAtual.epiId) || { nome: 'EPI não encontrado' };
            
            const conteudo = document.getElementById('detalhes-movimentacao-conteudo');
            document.getElementById('detalhes-movimentacao-titulo').textContent = 'Detalhes da Entrada';
            
            conteudo.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-gray-500">Data:</p>
                        <p class="font-medium">${formatarData(entradaAtual.data)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">EPI:</p>
                        <p class="font-medium">${epi.nome}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Quantidade:</p>
                        <p class="font-medium">${entradaAtual.quantidade} ${epi.unidade ? epi.unidade.toLowerCase() : ''}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Custo Unitário:</p>
                        <p class="font-medium">${formatarMoeda(entradaAtual.custo)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Valor Total:</p>
                        <p class="font-medium">${formatarMoeda(entradaAtual.quantidade * entradaAtual.custo)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Nota Fiscal:</p>
                        <p class="font-medium">${entradaAtual.notaFiscal || '-'}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Fornecedor:</p>
                        <p class="font-medium">${entradaAtual.fornecedor || '-'}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Responsável:</p>
                        <p class="font-medium">${entradaAtual.responsavel}</p>
                    </div>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Observações:</p>
                    <p class="mt-1">${entradaAtual.observacoes || 'Nenhuma observação.'}</p>
                </div>
            `;
            
            abrirModal('detalhes-movimentacao');
        }

        // Visualizar saída
        function visualizarSaida(id) {
            saidaAtual = listaSaidas.find(saida => saida.id === id);
            
            if (!saidaAtual) return;
            
            const epi = listaEPIs.find(e => e.id === saidaAtual.epiId) || { nome: 'EPI não encontrado', custo: 0 };
            const centro = listaCentros.find(c => c.id === saidaAtual.centroCustoId) || { nome: 'Centro de custo não encontrado' };
            
            const conteudo = document.getElementById('detalhes-movimentacao-conteudo');
            document.getElementById('detalhes-movimentacao-titulo').textContent = 'Detalhes da Saída';
            
            conteudo.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <p class="text-sm text-gray-500">Data:</p>
                        <p class="font-medium">${formatarData(saidaAtual.data)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">EPI:</p>
                        <p class="font-medium">${epi.nome}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Quantidade:</p>
                        <p class="font-medium">${saidaAtual.quantidade} ${epi.unidade ? epi.unidade.toLowerCase() : ''}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Centro de Custo:</p>
                        <p class="font-medium">${centro.nome}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Setor:</p>
                        <p class="font-medium">${centro.departamento}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Destino/Setor:</p>
                        <p class="font-medium">${saidaAtual.destino || '-'}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Valor Total:</p>
                        <p class="font-medium">${formatarMoeda(saidaAtual.quantidade * epi.custo)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Responsável pela Retirada:</p>
                        <p class="font-medium">${saidaAtual.responsavel}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">Funcionário Destinatário:</p>
                        <p class="font-medium">${saidaAtual.funcionario || '-'}</p>
                    </div>
                </div>
                <div>
                    <p class="text-sm text-gray-500">Motivo/Finalidade:</p>
                    <p class="mt-1">${saidaAtual.motivo || '-'}</p>
                </div>
            `;
            
            abrirModal('detalhes-movimentacao');
        }

        // Confirmar exclusão
        function confirmarExclusao(id, tipo) {
            let texto = '';
            let item = null;
            
            if (tipo === 'epi') {
                item = listaEPIs.find(epi => epi.id === id);
                if (!item) return;
                texto = `Tem certeza que deseja excluir o EPI "${item.nome}"? Esta ação não pode ser desfeita.`;
            } else if (tipo === 'entrada') {
                item = listaEntradas.find(entrada => entrada.id === id);
                if (!item) return;
                const epi = listaEPIs.find(e => e.id === item.epiId) || { nome: 'EPI não encontrado' };
                texto = `Tem certeza que deseja excluir esta entrada de ${item.quantidade} unidades de "${epi.nome}"? Esta ação ajustará o estoque e não pode ser desfeita.`;
            } else if (tipo === 'saida') {
                item = listaSaidas.find(saida => saida.id === id);
                if (!item) return;
                const epi = listaEPIs.find(e => e.id === item.epiId) || { nome: 'EPI não encontrado' };
                texto = `Tem certeza que deseja excluir esta saída de ${item.quantidade} unidades de "${epi.nome}"? Esta ação ajustará o estoque e não pode ser desfeita.`;
            } else if (tipo === 'centro') {
                item = listaCentros.find(centro => centro.id === id);
                if (!item) return;
                texto = `Tem certeza que deseja excluir o centro de custo "${item.nome}"? Esta ação não pode ser desfeita.`;
            } else if (tipo === 'provisao') {
                item = listaProvisoes.find(provisao => provisao.id === id);
                if (!item) return;
                const centro = listaCentros.find(c => c.id === item.centroCustoId) || { nome: 'Centro de custo não encontrado' };
                texto = `Tem certeza que deseja excluir o provisionamento de "${centro.nome}" para ${item.mesAnoReferencia}? Esta ação não pode ser desfeita.`;
            }
            
            document.getElementById('confirmacao-texto').textContent = texto;
            
            document.getElementById('btn-confirmar-exclusao').onclick = function() {
                excluirItem(id, tipo);
            };
            
            abrirModal('modal-confirmacao');
        }

        // Excluir item (EPI, entrada, saída, centro ou provisão)
        function excluirItem(id, tipo) {
            if (tipo === 'epi') {
                // Verificar se há entradas ou saídas relacionadas a este EPI
                const temEntradas = listaEntradas.some(entrada => entrada.epiId === id);
                const temSaidas = listaSaidas.some(saida => saida.epiId === id);
                const temProvisoes = listaProvisoes.some(provisao => provisao.itens.some(item => item.epiId === id));
                
                if (temEntradas || temSaidas || temProvisoes) {
                    mostrarToast('Não é possível excluir este EPI pois existem movimentações ou provisões vinculadas a ele.', 'erro');
                    fecharModal('modal-confirmacao');
                    return;
                }
                
                listaEPIs = listaEPIs.filter(epi => epi.id !== id);
                carregarTabelaEPIs();
                mostrarToast('EPI excluído com sucesso!', 'sucesso');
            } else if (tipo === 'entrada') {
                const entrada = listaEntradas.find(e => e.id === id);
                if (!entrada) return;
                
                // Encontrar o EPI relacionado
                const epi = listaEPIs.find(e => e.id === entrada.epiId);
                if (epi) {
                    // Subtrair a quantidade da entrada do estoque do EPI
                    epi.estoque -= entrada.quantidade;
                    if (epi.estoque < 0) epi.estoque = 0; // Evitar estoque negativo
                }
                
                listaEntradas = listaEntradas.filter(e => e.id !== id);
                carregarTabelaEntradas();
                mostrarToast('Entrada excluída e estoque atualizado com sucesso!', 'sucesso');
            } else if (tipo === 'saida') {
                const saida = listaSaidas.find(s => s.id === id);
                if (!saida) return;
                
                // Encontrar o EPI relacionado
                const epi = listaEPIs.find(e => e.id === saida.epiId);
                if (epi) {
                    // Adicionar a quantidade da saída de volta ao estoque do EPI
                    epi.estoque += saida.quantidade;
                }
                
                listaSaidas = listaSaidas.filter(s => s.id !== id);
                carregarTabelaSaidas();
                mostrarToast('Saída excluída e estoque atualizado com sucesso!', 'sucesso');
            } else if (tipo === 'centro') {
                // Verificar se há saídas ou provisões relacionadas a este centro de custo
                const temSaidas = listaSaidas.some(saida => saida.centroCustoId === id);
                const temProvisoes = listaProvisoes.some(provisao => provisao.centroCustoId === id);
                
                if (temSaidas || temProvisoes) {
                    mostrarToast('Não é possível excluir este centro de custo pois existem saídas ou provisões vinculadas a ele.', 'erro');
                    fecharModal('modal-confirmacao');
                    return;
                }
                
                listaCentros = listaCentros.filter(centro => centro.id !== id);
                carregarTabelaCentros();
                carregarSelectCentros('filtro-saida-centro');
                carregarSelectCentros('saida-centro-custo');
                carregarSelectCentros('filtro-provisao-centro');
                carregarSelectCentros('provisao-centro');
                carregarSelectCentros('relatorio-centro');
                
                mostrarToast('Centro de custo excluído com sucesso!', 'sucesso');
            } else if (tipo === 'provisao') {
                listaProvisoes = listaProvisoes.filter(provisao => provisao.id !== id);
                carregarTabelaProvisoes();
                mostrarToast('Provisionamento excluído com sucesso!', 'sucesso');
            }
            
            fecharModal('modal-confirmacao');
        }

        // Form submit handler para EPI
        document.getElementById('form-epi').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('epi-id').value;
            const epi = {
                nome: document.getElementById('epi-nome').value.trim(),
                codigo: document.getElementById('epi-codigo').value.trim(),
                categoria: document.getElementById('epi-categoria').value,
                unidade: document.getElementById('epi-unidade').value,
                estoque: parseInt(document.getElementById('epi-estoque').value),
                estoqueMinimo: parseInt(document.getElementById('epi-estoque-minimo').value),
                custo: parseFloat(document.getElementById('epi-custo').value),
                ca: document.getElementById('epi-ca').value.trim(),
                fornecedor: document.getElementById('epi-fornecedor').value.trim(),
                validade: document.getElementById('epi-validade').value,
                localizacao: document.getElementById('epi-localizacao').value.trim(),
                descricao: document.getElementById('epi-descricao').value.trim()
            };
            
            if (id) {
                // Edição
                epi.id = parseInt(id);
                const index = listaEPIs.findIndex(item => item.id === epi.id);
                if (index !== -1) {
                    listaEPIs[index] = epi;
                    mostrarToast('EPI atualizado com sucesso!', 'sucesso');
                }
            } else {
                // Novo cadastro
                epi.id = listaEPIs.length > 0 ? Math.max(...listaEPIs.map(item => item.id)) + 1 : 1;
                listaEPIs.push(epi);
                mostrarToast('EPI cadastrado com sucesso!', 'sucesso');
            }
            
            carregarTabelaEPIs();
            fecharModalCadastro();
            
            // Atualizar selects em todas as abas
            carregarSelectEPIs('filtro-entrada-epi');
            carregarSelectEPIs('entrada-epi');
            carregarSelectEPIs('filtro-saida-epi');
            carregarSelectEPIs('saida-epi');
        });

        // Form submit handler para Centro de Custo
        document.getElementById('form-centro').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('centro-id').value;
            const centro = {
                codigo: document.getElementById('centro-codigo').value.trim(),
                nome: document.getElementById('centro-nome').value.trim(),
                responsavel: document.getElementById('centro-responsavel').value.trim(),
                departamento: document.getElementById('centro-departamento').value.trim(),
                status: document.getElementById('centro-status').value,
                observacoes: document.getElementById('centro-observacoes').value.trim()
            };
            
            // Verificar se o código já existe (exceto para o mesmo centro que está sendo editado)
            const codigoExistente = listaCentros.find(c => 
                c.codigo === centro.codigo && (!id || c.id !== parseInt(id))
            );
            
            if (codigoExistente) {
                mostrarToast('O código informado já está em uso por outro centro de custo.', 'erro');
                return;
            }
            
            if (id) {
                // Edição
                centro.id = parseInt(id);
                const index = listaCentros.findIndex(c => c.id === centro.id);
                if (index !== -1) {
                    listaCentros[index] = centro;
                    mostrarToast('Centro de custo atualizado com sucesso!', 'sucesso');
                }
            } else {
                // Novo cadastro
                centro.id = listaCentros.length > 0 ? Math.max(...listaCentros.map(c => c.id)) + 1 : 1;
                listaCentros.push(centro);
                mostrarToast('Centro de custo cadastrado com sucesso!', 'sucesso');
            }
            
            carregarTabelaCentros();
            fecharModal('modal-centro');
            
            // Atualizar selects relacionados
            carregarSelectCentros('filtro-saida-centro');
            carregarSelectCentros('saida-centro-custo');
            carregarSelectCentros('filtro-provisao-centro');
            carregarSelectCentros('provisao-centro');
            carregarSelectCentros('relatorio-centro');
        });
        
        // Form submit handler para Provisionamento
        document.getElementById('form-provisao').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('provisao-id').value;
            const centroCustoId = parseInt(document.getElementById('provisao-centro').value);
            const mesAnoReferencia = document.getElementById('provisao-mes-ano').value;
            const responsavel = document.getElementById('provisao-responsavel').value.trim();
            const status = document.getElementById('provisao-status').value;
            const justificativa = document.getElementById('provisao-justificativa').value.trim();
            const observacoes = document.getElementById('provisao-observacoes').value.trim();
            
            // Validações
            if (!centroCustoId) {
                mostrarToast('Selecione um centro de custo válido.', 'erro');
                return;
            }
            
            if (!mesAnoReferencia) {
                mostrarToast('Selecione um mês/ano de referência.', 'erro');
                return;
            }
            
            if (itensProvisao.length === 0) {
                mostrarToast('Adicione pelo menos um item ao provisionamento.', 'erro');
                return;
            }
            
            // Dados do provisionamento
            const provisao = {
                centroCustoId,
                mesAnoReferencia,
                responsavel,
                status,
                justificativa,
                observacoes,
                itens: [...itensProvisao]
            };
            
            // Data de solicitação
            if (id) {
                // Manter a data original em caso de edição
                const provisaoOriginal = listaProvisoes.find(p => p.id === parseInt(id));
                provisao.dataSolicitacao = provisaoOriginal.dataSolicitacao;
            } else {
                // Nova data para novos registros
                const hoje = new Date().toISOString().split('T')[0];
                provisao.dataSolicitacao = hoje;
            }
            
            if (id) {
                // Edição
                provisao.id = parseInt(id);
                const index = listaProvisoes.findIndex(p => p.id === provisao.id);
                if (index !== -1) {
                    listaProvisoes[index] = provisao;
                    mostrarToast('Provisionamento atualizado com sucesso!', 'sucesso');
                }
            } else {
                // Novo cadastro
                provisao.id = listaProvisoes.length > 0 ? Math.max(...listaProvisoes.map(p => p.id)) + 1 : 1;
                listaProvisoes.push(provisao);
                mostrarToast('Provisionamento cadastrado com sucesso!', 'sucesso');
            }
            
            carregarTabelaProvisoes();
            fecharModal('modal-provisao');
            
            // Limpar a lista de itens para futuras adições
            itensProvisao = [];
        });

        // Form submit handler para Entrada
        document.getElementById('form-entrada').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const epiId = parseInt(document.getElementById('entrada-epi').value);
            const quantidade = parseInt(document.getElementById('entrada-quantidade').value);
            const custo = parseFloat(document.getElementById('entrada-custo').value);
            const data = document.getElementById('entrada-data').value;
            const notaFiscal = document.getElementById('entrada-nota-fiscal').value.trim();
            const fornecedor = document.getElementById('entrada-fornecedor').value.trim();
            const responsavel = document.getElementById('entrada-responsavel').value.trim();
            const observacoes = document.getElementById('entrada-observacoes').value.trim();
            
            // Validações
            if (!epiId) {
                mostrarToast('Selecione um EPI.', 'erro');
                return;
            }
            
            if (quantidade <= 0) {
                mostrarToast('A quantidade deve ser maior que zero.', 'erro');
                return;
            }
            
            // Encontrar o EPI
            const epi = listaEPIs.find(e => e.id === epiId);
            if (!epi) {
                mostrarToast('EPI não encontrado.', 'erro');
                return;
            }
            
            // Verificar se o custo foi alterado
            if (epi.custo !== custo) {
                // Preencher informações para o modal de confirmação
                document.getElementById('novo-custo').textContent = custo.toFixed(2).replace('.', ',');
                document.getElementById('custo-atual').textContent = epi.custo.toFixed(2).replace('.', ',');
                
                // Configurar botões
                document.getElementById('btn-manter-custo').onclick = function() {
                    atualizarCusto = false;
                    fecharModal('modal-confirmar-custo');
                    registrarEntrada(epiId, quantidade, custo, data, notaFiscal, fornecedor, responsavel, observacoes);
                };
                
                document.getElementById('btn-atualizar-custo').onclick = function() {
                    atualizarCusto = true;
                    fecharModal('modal-confirmar-custo');
                    registrarEntrada(epiId, quantidade, custo, data, notaFiscal, fornecedor, responsavel, observacoes);
                };
                
                // Mostrar modal de confirmação
                abrirModal('modal-confirmar-custo');
            } else {
                registrarEntrada(epiId, quantidade, custo, data, notaFiscal, fornecedor, responsavel, observacoes);
            }
        });

        // Função para registrar entrada
        function registrarEntrada(epiId, quantidade, custo, data, notaFiscal, fornecedor, responsavel, observacoes) {
            // Criar nova entrada
            const novaEntrada = {
                id: listaEntradas.length > 0 ? Math.max(...listaEntradas.map(e => e.id)) + 1 : 1,
                epiId,
                data,
                quantidade,
                custo,
                notaFiscal,
                fornecedor,
                responsavel,
                observacoes
            };
            
            // Adicionar à lista
            listaEntradas.push(novaEntrada);
            
            // Atualizar estoque do EPI
            const epi = listaEPIs.find(e => e.id === epiId);
            epi.estoque += quantidade;
            
            // Atualizar custo se necessário
            if (atualizarCusto) {
                epi.custo = custo;
                atualizarCusto = false; // Reset
            }
            
            // Fechar modal e mostrar feedback
            fecharModal('modal-entrada');
            mostrarToast('Entrada registrada com sucesso!', 'sucesso');
            
            // Atualizar tabela
            carregarTabelaEntradas();
        }

        // Form submit handler para Saída
        document.getElementById('form-saida').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const epiId = parseInt(document.getElementById('saida-epi').value);
            const quantidade = parseInt(document.getElementById('saida-quantidade').value);
            const data = document.getElementById('saida-data').value;
            const centroCustoId = parseInt(document.getElementById('saida-centro-custo').value);
            const destino = document.getElementById('saida-destino').value.trim();
            const responsavel = document.getElementById('saida-responsavel').value.trim();
            const funcionario = document.getElementById('saida-funcionario').value.trim();
            const motivo = document.getElementById('saida-motivo').value.trim();
            
            // Validações
            if (!epiId) {
                mostrarToast('Selecione um EPI.', 'erro');
                return;
            }
            
            if (quantidade <= 0) {
                mostrarToast('A quantidade deve ser maior que zero.', 'erro');
                return;
            }
            
            if (!centroCustoId) {
                mostrarToast('Selecione um centro de custo.', 'erro');
                return;
            }
            
            // Encontrar o EPI
            const epi = listaEPIs.find(e => e.id === epiId);
            if (!epi) {
                mostrarToast('EPI não encontrado.', 'erro');
                return;
            }
            
            // Verificar se há estoque suficiente
            if (epi.estoque < quantidade) {
                mostrarToast(`Estoque insuficiente. Disponível: ${epi.estoque} ${epi.unidade.toLowerCase()}`, 'erro');
                return;
            }
            
            // Criar nova saída
            const novaSaida = {
                id: listaSaidas.length > 0 ? Math.max(...listaSaidas.map(s => s.id)) + 1 : 1,
                epiId,
                data,
                quantidade,
                centroCustoId,
                destino,
                responsavel,
                funcionario,
                motivo
            };
            
            // Adicionar à lista
            listaSaidas.push(novaSaida);
            
            // Atualizar estoque do EPI
            epi.estoque -= quantidade;
            
            // Fechar modal e mostrar feedback
            fecharModal('modal-saida');
            mostrarToast('Saída registrada com sucesso!', 'sucesso');
            
            // Atualizar tabela
            carregarTabelaSaidas();
        });

        // Funções para gerenciamento de usuários
        
        // Mostrar/esconder senha no formulário
        function toggleSenha() {
            const inputSenha = document.getElementById('usuario-senha');
            const iconeSenha = document.getElementById('icone-senha');
            
            if (inputSenha.type === 'password') {
                inputSenha.type = 'text';
                iconeSenha.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                inputSenha.type = 'password';
                iconeSenha.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }
        
        // Abrir modal de usuário
        function abrirModalUsuario() {
            document.getElementById('modal-titulo-usuario').textContent = 'Novo Usuário';
            document.getElementById('form-usuario').reset();
            document.getElementById('usuario-id').value = '';
            document.getElementById('div-senha').classList.remove('hidden');
            document.getElementById('usuario-senha').required = true;
            document.getElementById('usuario-status').value = 'Ativo';
            
            abrirModal('modal-usuario');
        }
        
        // Buscar usuários
        function buscarUsuarios() {
            const textoBusca = document.getElementById('busca-usuario').value.toLowerCase();
            
            if (!textoBusca) {
                carregarTabelaUsuarios();
                return;
            }
            
            const resultado = listaUsuarios.filter(usuario => 
                usuario.nome.toLowerCase().includes(textoBusca) || 
                usuario.login.toLowerCase().includes(textoBusca)
            );
            
            carregarTabelaUsuarios(resultado);
            
            if (resultado.length === 0) {
                mostrarToast('Nenhum usuário encontrado com o termo buscado.', 'info');
            }
        }
        
        // Carregar tabela de usuários
        function carregarTabelaUsuarios(lista = listaUsuarios) {
            const tabela = document.getElementById('tabela-usuarios');
            const semRegistros = document.getElementById('sem-registros-usuarios');
            
            // Limpa a tabela
            tabela.innerHTML = '';
            
            if (lista.length === 0) {
                tabela.parentElement.classList.add('hidden');
                semRegistros.classList.remove('hidden');
                return;
            }
            
            tabela.parentElement.classList.remove('hidden');
            semRegistros.classList.add('hidden');
            
            // Adiciona cada usuário à tabela
            lista.forEach(usuario => {
                const tr = document.createElement('tr');
                
                const statusClass = usuario.status === 'Ativo' ? 'text-success' : 'text-danger';
                
                // Não permitir editar/excluir o próprio usuário
                const podeEditar = !usuarioAtual || usuario.id !== usuarioAtual.id;
                
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">${usuario.nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${usuario.login}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${usuario.perfil}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${statusClass} font-medium">${usuario.status}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${usuario.ultimoAcesso || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button 
                            onclick="editarUsuario(${usuario.id})" 
                            class="text-primary hover:text-primary/80 mr-2 ${!podeEditar ? 'opacity-50 cursor-not-allowed' : ''}" 
                            title="Editar"
                            ${!podeEditar ? 'disabled' : ''}
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        <button 
                            onclick="confirmarExclusaoUsuario(${usuario.id})" 
                            class="text-danger hover:text-danger/80 ${!podeEditar ? 'opacity-50 cursor-not-allowed' : ''}" 
                            title="Excluir"
                            ${!podeEditar ? 'disabled' : ''}
                        >
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                
                tabela.appendChild(tr);
            });
        }
        
        // Editar usuário
        function editarUsuario(id) {
            const usuario = listaUsuarios.find(u => u.id === id);
            if (!usuario) return;
            
            document.getElementById('modal-titulo-usuario').textContent = `Editar Usuário: ${usuario.nome}`;
            document.getElementById('usuario-id').value = usuario.id;
            document.getElementById('usuario-nome').value = usuario.nome;
            document.getElementById('usuario-login').value = usuario.login;
            document.getElementById('usuario-perfil').value = usuario.perfil;
            document.getElementById('usuario-status').value = usuario.status;
            
            // Não mostrar campo de senha na edição (ou deixar opcional)
            document.getElementById('div-senha').classList.add('hidden');
            document.getElementById('usuario-senha').required = false;
            
            abrirModal('modal-usuario');
        }
        
        // Confirmar exclusão de usuário
        function confirmarExclusaoUsuario(id) {
            const usuario = listaUsuarios.find(u => u.id === id);
            if (!usuario) return;
            
            // Não permitir excluir o próprio usuário
            if (usuarioAtual && usuario.id === usuarioAtual.id) {
                mostrarToast('Não é possível excluir seu próprio usuário.', 'erro');
                return;
            }
            
            // Confirmar exclusão
            document.getElementById('confirmacao-texto').textContent = 
                `Tem certeza que deseja excluir o usuário "${usuario.nome}"?`;
            
            document.getElementById('btn-confirmar-exclusao').onclick = function() {
                listaUsuarios = listaUsuarios.filter(u => u.id !== id);
                fecharModal('modal-confirmacao');
                carregarTabelaUsuarios();
                mostrarToast('Usuário excluído com sucesso!', 'sucesso');
            };
            
            abrirModal('modal-confirmacao');
        }
        
        // Form submit handler para Usuário
        document.getElementById('form-usuario').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('usuario-id').value;
            const usuario = {
                nome: document.getElementById('usuario-nome').value.trim(),
                login: document.getElementById('usuario-login').value.trim(),
                perfil: document.getElementById('usuario-perfil').value,
                status: document.getElementById('usuario-status').value
            };
            
            // Se tiver senha preenchida, incluir
            const senha = document.getElementById('usuario-senha').value;
            if (senha) {
                // Em uma implementação real, a senha seria hasheada aqui
                usuario.senha = senha;
            }
            
            // Verificar se o login já existe (exceto para o mesmo usuário na edição)
            const loginExistente = listaUsuarios.find(u => 
                u.login === usuario.login && (!id || u.id !== parseInt(id))
            );
            
            if (loginExistente) {
                mostrarToast('Este nome de usuário já está em uso.', 'erro');
                return;
            }
            
            if (id) {
                // Edição
                usuario.id = parseInt(id);
                const index = listaUsuarios.findIndex(u => u.id === usuario.id);
                
                if (index !== -1) {
                    // Manter a senha se não foi fornecida nova
                    if (!usuario.senha) {
                        usuario.senha = listaUsuarios[index].senha;
                    }
                    
                    // Manter o último acesso
                    usuario.ultimoAcesso = listaUsuarios[index].ultimoAcesso;
                    
                    listaUsuarios[index] = usuario;
                    mostrarToast('Usuário atualizado com sucesso!', 'sucesso');
                }
            } else {
                // Novo cadastro
                if (!usuario.senha) {
                    mostrarToast('A senha é obrigatória para novos usuários.', 'erro');
                    return;
                }
                
                usuario.id = listaUsuarios.length > 0 ? Math.max(...listaUsuarios.map(u => u.id)) + 1 : 1;
                usuario.ultimoAcesso = null;
                listaUsuarios.push(usuario);
                mostrarToast('Usuário cadastrado com sucesso!', 'sucesso');
            }
            
            fecharModal('modal-usuario');
            carregarTabelaUsuarios();
        });
        
        // Verificar login
        function realizarLogin(event) {
            event.preventDefault();
            
            const login = document.getElementById('usuario').value;
            const senha = document.getElementById('senha').value;
            const erroLogin = document.getElementById('erro-login');
            
            // Verificar credenciais
            const usuario = listaUsuarios.find(u => 
                u.login === login && 
                u.senha === senha && 
                u.status === 'Ativo'
            );
            
            if (usuario) {
                // Login bem-sucedido
                usuarioAtual = usuario;
                
                // Registrar data/hora do acesso
                const agora = new Date();
                const dataHora = `${agora.toLocaleDateString()} ${agora.toLocaleTimeString()}`;
                usuario.ultimoAcesso = dataHora;
                
                // Mostrar a interface principal
                document.getElementById('tela-login').classList.add('hidden');
                document.getElementById('tela-principal').classList.remove('hidden');
                
                // Aplicar permissões na interface
                aplicarPermissoes();
                
                // Mostrar quem está logado
                document.getElementById('usuario-logado').textContent = usuario.nome;
                
                // Carregar a primeira aba
                mudarTab('epis');
                
                // Mostrar notificação
                mostrarToast(`Bem-vindo, ${usuario.nome}!`, 'sucesso');
            } else {
                // Login falhou
                erroLogin.textContent = 'Usuário ou senha incorretos';
                erroLogin.classList.remove('hidden');
            }
        }
        
        // Verificar se o usuário está logado (ao carregar a página)
        function verificarLogin() {
            // No início, não há usuário logado
            if (!usuarioAtual) {
                // Mostrar tela de login
                document.getElementById('tela-login').classList.remove('hidden');
                document.getElementById('tela-principal').classList.add('hidden');
                return;
            }
            
            // Se já houver um usuário logado
            if (usuarioAtual.status === 'Ativo') {
                // Mostrar a interface principal
                document.getElementById('tela-login').classList.add('hidden');
                document.getElementById('tela-principal').classList.remove('hidden');
                
                // Aplicar permissões
                aplicarPermissoes();
                
                // Mostrar quem está logado
                document.getElementById('usuario-logado').textContent = usuarioAtual.nome;
                
                // Carregar a primeira aba
                mudarTab('epis');
                return;
            }
            
            // Se o usuário não estiver ativo, mostrar tela de login
            document.getElementById('tela-login').classList.remove('hidden');
            document.getElementById('tela-principal').classList.add('hidden');
        }
        
        // Fazer logout
        function realizarLogout() {
            usuarioAtual = null;
            document.getElementById('tela-login').classList.remove('hidden');
            document.getElementById('tela-principal').classList.add('hidden');
            document.getElementById('erro-login').classList.add('hidden');
            
            // Limpar campos do formulário de login
            document.getElementById('usuario').value = '';
            document.getElementById('senha').value = '';
            
            mostrarToast('Logout realizado com sucesso!', 'info');
        }
        
        // Aplicar permissões na interface com base no perfil do usuário
        function aplicarPermissoes() {
            if (!usuarioAtual) return;
            
            const perfil = usuarioAtual.perfil;
            
            // Aba de usuários (apenas para Administrador)
            const tabUsuarios = document.getElementById('tab-usuarios');
            if (perfil !== 'Administrador') {
                tabUsuarios.classList.add('hidden');
            } else {
                tabUsuarios.classList.remove('hidden');
            }
            
            if (perfil === 'Administrador') {
                // Administrador tem acesso completo, nada a fazer
                return;
            }
            
            // Botões de ação para Visualizador (ocultar todos os botões de adicionar, editar e excluir)
            if (perfil === 'Visualizador') {
                // Ocultar botões de ação em todas as abas
                document.querySelectorAll('button[onclick*="abrirModal"], button[onclick*="editar"], button[onclick*="excluir"], button[onclick*="confirmar"]').forEach(btn => {
                    if (!btn.onclick.toString().includes('logout')) { // Não ocultar o botão de logout
                        btn.classList.add('hidden');
                    }
                });
            }
            
            // Permissões específicas para Operador (pode gerenciar estoque, mas não usuários ou aprovar/rejeitar provisionamentos)
            if (perfil === 'Operador') {
                // Permitir botões de entrada/saída e gestão de EPIs
                
                // Restringir aprovação/rejeição de provisionamentos
                document.querySelectorAll('#btn-aprovar-provisao, #btn-rejeitar-provisao').forEach(btn => {
                    btn.classList.add('hidden');
                });
            }
        }
        
        // Abrir modal de cadastro de usuário
        function abrirModalCadastroUsuario() {
            document.getElementById('form-cadastro-usuario').reset();
            document.getElementById('erro-cadastro').classList.add('hidden');
            abrirModal('modal-cadastro-usuario');
        }
        
        // Alternar visibilidade da senha no formulário de cadastro
        function toggleSenhaCadastro() {
            const inputSenha = document.getElementById('cadastro-senha');
            const iconeSenha = document.getElementById('icone-senha-cadastro');
            
            if (inputSenha.type === 'password') {
                inputSenha.type = 'text';
                iconeSenha.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                inputSenha.type = 'password';
                iconeSenha.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }
        
        // Inicialização
        window.addEventListener('DOMContentLoaded', function() {
            // Inicializar sistema de login
            document.getElementById('form-login').addEventListener('submit', realizarLogin);
            
            // Inicializar sistema de cadastro
            // Remove event listener for cadastro form as we're not using self-registration
            
            verificarLogin();
            
            // Data padrão para os campos de data
            const hoje = new Date().toISOString().split('T')[0];
            if (document.getElementById('entrada-data')) {
                document.getElementById('entrada-data').value = hoje;
            }
            if (document.getElementById('saida-data')) {
                document.getElementById('saida-data').value = hoje;
            }
            
            // Inicializar datas para relatório
            inicializarRelatorios();
            
            // Carregar dados iniciais
            carregarTabelaEPIs();
            carregarTabelaUsuarios();
            carregarSelectEPIs('filtro-entrada-epi');
            carregarSelectEPIs('entrada-epi');
            carregarSelectEPIs('filtro-saida-epi');
            carregarSelectEPIs('saida-epi');
            carregarSelectCentros('filtro-saida-centro');
            carregarSelectCentros('saida-centro-custo');
            carregarSelectCentros('filtro-provisao-centro');
            carregarSelectCentros('provisao-centro');
            carregarSelectCentros('relatorio-centro');
            
            // Handler para tecla Enter nos campos de busca
            document.getElementById('busca-epi').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    buscarEPIs();
                }
            });
            
            document.getElementById('busca-centro').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    buscarCentros();
                }
            });
            
            document.getElementById('busca-usuario').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    buscarUsuarios();
                }
            });
        });
    </script>
</body>
</html>
